# 日志远程调度接口实现文档

## 概述

本文档描述了 WorkToolBot 日志远程调度接口的服务器端实现，包括数据库表结构、API 接口、WebSocket 实时推送和客户端 SDK。

## 实现内容

### 1. 数据库表结构

#### 1.1 logs 表
用于存储远程客户端上传的日志条目。

**字段说明**:
- `id`: 日志唯一标识（VARCHAR(64), 主键）
- `robot_id`: 机器人ID（VARCHAR(64)）
- `timestamp`: Unix 毫秒时间戳（BIGINT）
- `level`: 日志级别（INTEGER, 0-5）
- `tag`: 日志标签（来源模块）（VARCHAR(128)）
- `message`: 日志消息（TEXT）
- `extra`: 扩展信息（JSON 格式）（TEXT）
- `stack_trace`: 异常堆栈（TEXT）
- `sync_status`: 同步状态（VARCHAR(20)）
- `sync_time`: 同步时间戳（BIGINT）
- `device_id`: 设备ID（VARCHAR(128)）
- `created_at`: 创建时间（TIMESTAMP）

**索引**:
- `logs_robot_id_idx`: robot_id
- `logs_timestamp_idx`: timestamp
- `logs_level_idx`: level
- `logs_tag_idx`: tag
- `logs_sync_status_idx`: sync_status

#### 1.2 log_configs 表
用于存储客户端的日志配置。

**字段说明**:
- `robot_id`: 机器人ID（VARCHAR(64), 主键）
- `log_level`: 日志级别（INTEGER, 默认 2）
- `upload_enabled`: 是否启用上传（BOOLEAN, 默认 true）
- `upload_interval`: 上传间隔（毫秒）（INTEGER, 默认 300000）
- `upload_on_wifi_only`: 仅 WiFi 上传（BOOLEAN, 默认 true）
- `max_log_entries`: 最大日志条数（INTEGER, 默认 10000）
- `retention_days`: 保留天数（INTEGER, 默认 30）
- `tags`: 各模块的日志级别配置（JSON）（TEXT）
- `updated_at`: 更新时间（TIMESTAMP）

### 2. API 接口

#### 2.1 上传日志
- **接口**: `POST /api/v1/logs/upload`
- **认证**: Bearer Token
- **请求体**:
  ```json
  {
    "robotId": "robot_123456789",
    "logs": [
      {
        "id": "uuid-1",
        "timestamp": 1707350400000,
        "level": 2,
        "tag": "RobotService",
        "message": "机器人已启动",
        "extra": {...},
        "stackTrace": "...",
        "deviceId": "device_fingerprint_123"
      }
    ]
  }
  ```
- **响应**:
  ```json
  {
    "success": true,
    "message": "日志上传成功",
    "data": {
      "uploaded": 50,
      "failed": 2,
      "failedIds": ["uuid-1", "uuid-5"]
    }
  }
  ```

#### 2.2 查询日志
- **接口**: `GET /api/v1/logs/query`
- **认证**: Bearer Token
- **Query 参数**:
  - `robotId`: 机器人ID（必需）
  - `level`: 日志级别筛选（可选）
  - `tag`: 日志标签筛选（可选）
  - `startTime`: 开始时间戳（可选）
  - `endTime`: 结束时间戳（可选）
  - `keyword`: 关键词搜索（可选）
  - `page`: 页码（默认 1）
  - `pageSize`: 每页数量（默认 50）
- **响应**:
  ```json
  {
    "success": true,
    "message": "查询成功",
    "data": {
      "total": 150,
      "page": 1,
      "pageSize": 50,
      "logs": [...],
      "totalPages": 3
    }
  }
  ```

#### 2.3 获取日志配置
- **接口**: `GET /api/v1/logs/config?robotId=xxx`
- **认证**: Bearer Token
- **响应**:
  ```json
  {
    "success": true,
    "message": "获取配置成功",
    "data": {
      "robotId": "robot_123",
      "logLevel": 2,
      "uploadEnabled": true,
      "uploadInterval": 300000,
      "uploadOnWifiOnly": true,
      "maxLogEntries": 10000,
      "retentionDays": 30,
      "tags": {...},
      "updatedAt": 1707350400000
    }
  }
  ```

#### 2.4 更新日志配置
- **接口**: `POST /api/v1/logs/config`
- **认证**: Bearer Token
- **请求体**:
  ```json
  {
    "robotId": "robot_123456789",
    "logLevel": 2,
    "uploadEnabled": true,
    "uploadInterval": 300000,
    "uploadOnWifiOnly": true,
    "maxLogEntries": 10000,
    "retentionDays": 30,
    "tags": {...}
  }
  ```
- **响应**:
  ```json
  {
    "success": true,
    "message": "配置更新成功",
    "data": {
      "configId": "config_123",
      "updatedAt": 1707350400000
    }
  }
  ```

### 3. WebSocket 实时推送

#### 3.1 连接
- **接口**: `WS /api/v1/logs/stream`
- **连接 URL**:
  ```
  ws://localhost:5000/api/v1/logs/stream?robotId=xxx&token=xxx
  ```
- **认证流程**:
  1. 客户端连接时传递 `robotId` 和 `token` 参数
  2. 服务器验证 Token 有效性
  3. 认证成功后返回：
     ```json
     {
       "type": "authenticated",
       "message": "认证成功",
       "data": {
         "robotId": "xxx",
         "timestamp": 1707350400000
       }
     }
     ```

#### 3.2 消息类型

**客户端 → 服务器**:
- `ping`: 心跳
- `subscribe`: 订阅实时日志推送
- `unsubscribe`: 取消订阅

**服务器 → 客户端**:
- `authenticated`: 认证成功
- `pong`: 心跳响应
- `log`: 实时日志推送
- `config_update`: 配置变更通知

### 4. 客户端 SDK

#### 4.1 WorkToolLogClient
HTTP API 客户端，提供日志上传、查询和配置功能。

**使用示例**:
```typescript
import { WorkToolLogClient, LogLevel } from './WorkToolLogClient';

const client = new WorkToolLogClient({
  baseUrl: 'https://gbdvprr2vy.coze.site',
  token: 'your_token_here',
  robotId: 'robot_123456789',
});

// 上传日志
await client.uploadLogs([
  {
    id: 'log_1',
    timestamp: Date.now(),
    level: LogLevel.INFO,
    tag: 'RobotService',
    message: '机器人已启动',
    extra: { batteryLevel: 85 },
  },
]);

// 查询日志
const result = await client.queryLogs({
  level: LogLevel.ERROR,
  page: 1,
  pageSize: 50,
});

// 获取配置
const config = await client.getLogConfig();

// 更新配置
await client.updateLogConfig({
  logLevel: LogLevel.WARN,
  uploadEnabled: true,
});
```

#### 4.2 LogStreamClient
WebSocket 客户端，提供实时日志推送功能。

**使用示例**:
```typescript
import { LogStreamClient } from './WorkToolLogClient';

const streamClient = new LogStreamClient({
  baseUrl: 'https://gbdvprr2vy.coze.site',
  token: 'your_token_here',
  robotId: 'robot_123456789',
});

// 连接
await streamClient.connect();

// 注册消息处理器
streamClient.on('log', (data) => {
  console.log('收到实时日志:', data);
});

streamClient.on('config_update', (data) => {
  console.log('配置已更新:', data);
});

// 订阅实时日志
streamClient.subscribe();

// 取消订阅
streamClient.unsubscribe();

// 断开连接
streamClient.disconnect();
```

### 5. 部署说明

#### 5.1 创建数据库表
```bash
curl -X POST http://localhost:5000/api/db/create-log-tables
```

#### 5.2 修复字段类型（如果需要）
```bash
curl -X POST http://localhost:5000/api/db/fix-log-tables
```

#### 5.3 验证接口
```bash
bash scripts/test-log-apis.sh
```

### 6. 测试结果

所有接口已测试通过：

| 接口 | 状态 | 说明 |
|------|------|------|
| POST /api/v1/logs/upload | ✅ 通过 | 日志上传成功 |
| GET /api/v1/logs/query | ✅ 通过 | 日志查询成功 |
| GET /api/v1/logs/config | ✅ 通过 | 获取配置成功 |
| POST /api/v1/logs/config | ✅ 通过 | 更新配置成功 |
| WS /api/v1/logs/stream | ✅ 通过 | WebSocket 连接成功 |

### 7. 文件清单

**数据库 Schema**:
- `src/storage/database/shared/schema.ts` - 添加了 `logs` 和 `log_configs` 表定义

**API 路由**:
- `src/app/api/v1/logs/upload/route.ts` - 日志上传接口
- `src/app/api/v1/logs/query/route.ts` - 日志查询接口
- `src/app/api/v1/logs/config/route.ts` - 日志配置接口

**WebSocket**:
- `src/server/websocket-server.ts` - 添加了 `/api/v1/logs/stream` 路由处理

**数据库迁移**:
- `src/app/api/db/create-log-tables/route.ts` - 创建日志表
- `src/app/api/db/fix-log-tables/route.ts` - 修复字段类型

**客户端 SDK**:
- `docs/WorkToolLogClient.ts` - TypeScript 客户端库

**测试脚本**:
- `scripts/test-log-apis.sh` - API 接口测试脚本

### 8. 注意事项

1. **Token 验证**: 当前实现中 Token 验证已预留接口，但未完全实现。生产环境需要实现完整的 Token 验证逻辑。
2. **权限控制**: 需要添加用户权限检查，确保用户只能查询和修改自己授权的机器人日志。
3. **数据脱敏**: 日志中可能包含敏感信息，需要在查询和展示时进行脱敏处理。
4. **性能优化**: 对于大量日志的查询，建议添加分页、索引和缓存机制。
5. **错误处理**: 需要完善错误处理逻辑，包括网络错误、数据库错误、认证错误等。

### 9. 后续优化

1. **日志分析**: 添加日志统计和分析功能
2. **告警机制**: 实现基于日志的告警功能
3. **日志导出**: 支持导出日志为文件
4. **实时监控**: 添加实时日志监控面板
5. **日志清理**: 实现自动清理过期日志的任务

---

**文档版本**: v1.0.0
**更新日期**: 2026-02-08
