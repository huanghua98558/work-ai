# WorkBot ç¬¬ä¸‰æ–¹é›†æˆå®æ–½æ–¹æ¡ˆ

## æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£åŸºäº WorkBot ç³»ç»Ÿçš„å®é™…æ¥å£ï¼Œé‡æ–°åˆ¶å®šç¬¬ä¸‰æ–¹é›†æˆå®æ–½æ–¹æ¡ˆã€‚

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0
**åˆ†ææ—¥æœŸ**: 2026-02-09
**æ–¹æ¡ˆ**: APP ç›´æ¥å‘é€æ¶ˆæ¯åˆ°ç¬¬ä¸‰æ–¹å¹³å° + æ™ºèƒ½å›é€€æœºåˆ¶

---

## ä¸€ã€é€šè®¯æ¶æ„åˆ†æ

### 1.1 å®Œæ•´æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å®¢æˆ·ç«¯å±‚                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Admin Web  â”‚  â”‚   User Web   â”‚  â”‚ WorkTool App â”‚      â”‚
â”‚  â”‚  (ç®¡ç†åå°)   â”‚  â”‚  (ç”¨æˆ·å‰ç«¯)   â”‚  â”‚  (Android)   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    WorkBot æœåŠ¡å™¨å±‚                           â”‚
â”‚                    https://api.worktool.ymdyes.cn            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚           Next.js HTTP Server (5000)                â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚   API     â”‚  â”‚   Pages   â”‚  â”‚   WebSocket     â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  Routes   â”‚  â”‚  (Admin)  â”‚  â”‚   Server v3.0   â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                               â”‚
              â–¼                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    ç¬¬ä¸‰æ–¹å¹³å°            â”‚      â”‚   WorkTool App          â”‚
â”‚  (Dify/è±†åŒ…/è‡ªå®šä¹‰)      â”‚      â”‚  (é€šè¿‡ WebSocket)       â”‚
â”‚  - æ¶ˆæ¯å›è°ƒåœ°å€          â”‚      â”‚  - æŒ‡ä»¤æ¨é€             â”‚
â”‚  - ç»“æœå›è°ƒåœ°å€          â”‚      â”‚  - é…ç½®æ¨é€             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 WorkBot æœåŠ¡å™¨æ¥å£æ¸…å•

#### æ ¸å¿ƒæ¥å£ï¼ˆå·²å®ç°ï¼‰

| æ¥å£è·¯å¾„ | æ–¹æ³• | è¯´æ˜ | ä¼˜å…ˆçº§ |
|---------|------|------|--------|
| `/wework/sendRawMessage` | POST | å‘é€ä¼ä¸šå¾®ä¿¡æ¶ˆæ¯ | ğŸ”´ é«˜ |
| `/robot/robotInfo/update` | POST | æ›´æ–°æœºå™¨äººé…ç½® | ğŸ”´ é«˜ |
| `/robot/robotInfo/get` | GET | è·å–æœºå™¨äººä¿¡æ¯ | ğŸ”´ é«˜ |
| `/robot/robotInfo/online` | GET | æŸ¥è¯¢æœºå™¨äººæ˜¯å¦åœ¨çº¿ | ğŸŸ¡ ä¸­ |
| `/robot/robotInfo/onlineInfos` | GET | æŸ¥è¯¢æœºå™¨äººç™»å½•æ—¥å¿— | ğŸŸ¢ ä½ |
| `/wework/listRawMessage` | GET | æŒ‡ä»¤æ¶ˆæ¯APIè°ƒç”¨æŸ¥è¯¢ | ğŸŸ¡ ä¸­ |
| `/robot/rawMsg/list` | GET | æŒ‡ä»¤æ‰§è¡Œç»“æœæŸ¥è¯¢ | ğŸŸ¡ ä¸­ |
| `/robot/qaLog/list` | GET | æœºå™¨äººæ¶ˆæ¯å›è°ƒæ—¥å¿—åˆ—è¡¨ | ğŸŸ¢ ä½ |
| `/api/robot-ids/activate` | POST | è®¾å¤‡æ¿€æ´» | ğŸ”´ é«˜ |
| `/api/worktool/callback` | POST | WorkTool å›è°ƒ | ğŸ”´ é«˜ |
| `/api/worktool/sendMessage` | POST | å‘é€ WorkTool æ¶ˆæ¯ | ğŸ”´ é«˜ |

#### éœ€è¦æ–°å¢çš„æ¥å£

| æ¥å£è·¯å¾„ | æ–¹æ³• | è¯´æ˜ | ä¼˜å…ˆçº§ |
|---------|------|------|--------|
| `/api/device/config` | GET | è®¾å¤‡é…ç½®æŸ¥è¯¢ï¼ˆå…œåº•æ–¹æ¡ˆï¼‰ | ğŸ”´ é«˜ |
| `/api/third-party/callback/{type}` | POST | ç¬¬ä¸‰æ–¹å›è°ƒç»Ÿä¸€æ¥å£ | ğŸ”´ é«˜ |
| `/api/third-party/fallback/message` | POST | æ¶ˆæ¯å›é€€æ¥å£ | ğŸ”´ é«˜ |
| `/api/robots/[robotId]/config` | GET/PUT | æœºå™¨äººé…ç½®ç®¡ç† | ğŸŸ¡ ä¸­ |
| `/api/robots/[robotId]/config-status` | GET | é…ç½®åŒæ­¥çŠ¶æ€æŸ¥è¯¢ | ğŸŸ¡ ä¸­ |
| `/api/worktool/message-log` | POST | æ¶ˆæ¯æ—¥å¿—ä¸ŠæŠ¥ | ğŸŸ¡ ä¸­ |

### 1.3 ç¬¬ä¸‰æ–¹å¹³å°é€šè®¯æµç¨‹

#### é…ç½®å­—æ®µè¯´æ˜

**robots è¡¨ä¸­çš„ç¬¬ä¸‰æ–¹é…ç½®å­—æ®µ**ï¼š
- `thirdPartyCallbackUrl`: ç¬¬ä¸‰æ–¹å¹³å°çš„æ¶ˆæ¯å›è°ƒåœ°å€
  - APP å‘é€æ¶ˆæ¯çš„ç›®æ ‡åœ°å€
  - æ ¼å¼ï¼š`https://api.dify.ai/callback`
  - APP ç”Ÿæˆå®Œæ•´å›è°ƒåœ°å€ï¼š`{url}/api/worktool/callback/{type}?robotId={robotId}`

- `thirdPartyResultCallbackUrl`: ç¬¬ä¸‰æ–¹å¹³å°çš„ç»“æœå›è°ƒåœ°å€
  - ç¬¬ä¸‰æ–¹å¹³å°å¤„ç†å®Œæ¶ˆæ¯åï¼Œè°ƒç”¨ WorkBot æœåŠ¡å™¨å‘é€å›å¤
  - æ ¼å¼ï¼š`https://api.worktool.ymdyes.cn/wework/sendRawMessage?robotId={robotId}`

- `thirdPartySecretKey`: ç¬¬ä¸‰æ–¹å¹³å°çš„å¯†é’¥
  - ç”¨äºç­¾åéªŒè¯ï¼ˆå¯é€‰ï¼‰
  - ä¿è¯å®‰å…¨æ€§

#### å®Œæ•´é€šè®¯æµç¨‹

```
1. é…ç½®é˜¶æ®µ
   ç®¡ç†å‘˜åœ¨åå°é…ç½®ï¼š
   - thirdPartyCallbackUrl: https://api.dify.ai/callback
   - thirdPartyResultCallbackUrl: https://api.worktool.ymdyes.cn/wework/sendRawMessage
   - thirdPartySecretKey: secret_xxx

2. é…ç½®åŒæ­¥
   æœåŠ¡å™¨ â†’ APP (WebSocket):
   {
     type: "config_push",
     data: {
       worktoolApiUrl: "https://api.dify.ai/callback",
       resultCallbackUrl: "https://api.worktool.ymdyes.cn/wework/sendRawMessage",
       robotId: "wt22phhjpt2xboerspxsote472xdnyq2",
       secretKey: "secret_xxx",
       updatedAt: 1739085600000,
       version: "1.0"
     }
   }

   APP ä¿å­˜é…ç½®åç¡®è®¤ï¼š
   {
     type: "config_ack",
     data: {
       robotId: "wt22phhjpt2xboerspxsote472xdnyq2",
       configVersion: "1.0",
       ackTime: "2026-02-09T10:01:00.000Z"
     }
   }

3. æ¶ˆæ¯å‘é€æµç¨‹ï¼ˆæ­£å¸¸ï¼‰
   APP æ”¶åˆ°ä¼ä¸šå¾®ä¿¡æ¶ˆæ¯
   â†’ ç”Ÿæˆå›è°ƒåœ°å€ï¼šhttps://api.dify.ai/callback/api/worktool/callback/message?robotId=wt22phhjpt2xboerspxsote472xdnyq2
   â†’ å‘é€æ¶ˆæ¯åˆ°ç¬¬ä¸‰æ–¹å¹³å°

   ç¬¬ä¸‰æ–¹å¹³å°å¤„ç†æ¶ˆæ¯
   â†’ ç”Ÿæˆ AI å›å¤
   â†’ è°ƒç”¨ WorkBot æœåŠ¡å™¨ï¼šhttps://api.worktool.ymdyes.cn/wework/sendRawMessage?robotId=wt22phhjpt2xboerspxsote472xdnyq2
   â†’ WorkBot æœåŠ¡å™¨é€šè¿‡ WebSocket æ¨é€ç»™ APP
   â†’ APP æ‰§è¡ŒæŒ‡ä»¤ï¼Œå‘é€åˆ°ä¼ä¸šå¾®ä¿¡

4. æ¶ˆæ¯å‘é€æµç¨‹ï¼ˆå›é€€ï¼‰
   APP æ”¶åˆ°ä¼ä¸šå¾®ä¿¡æ¶ˆæ¯
   â†’ å‘é€æ¶ˆæ¯åˆ°ç¬¬ä¸‰æ–¹å¹³å°
   â†’ ç¬¬ä¸‰æ–¹å¹³å°è¿”å›é”™è¯¯ï¼ˆ500ã€è¶…æ—¶ç­‰ï¼‰

   APP æ£€æµ‹åˆ°å¤±è´¥ï¼Œè§¦å‘å›é€€ï¼š
   â†’ è°ƒç”¨ WorkBot æœåŠ¡å™¨ï¼šhttps://api.worktool.ymdyes.cn/api/third-party/fallback/message
   â†’ WorkBot æœåŠ¡å™¨ä½¿ç”¨å†…ç½® AI å¤„ç†æ¶ˆæ¯
   â†’ é€šè¿‡ WebSocket æ¨é€ç»™ APP
   â†’ APP æ‰§è¡ŒæŒ‡ä»¤ï¼Œå‘é€åˆ°ä¼ä¸šå¾®ä¿¡
```

---

## äºŒã€æ•°æ®åº“è¡¨æ‰©å±•

### 2.1 éœ€è¦æ–°å¢çš„è¡¨

#### 2.1.1 è®¾å¤‡æ¿€æ´»è¡¨ (device_activations)

**è¯´æ˜**: è®°å½• APP æ¿€æ´»çŠ¶æ€å’Œé…ç½®åŒæ­¥æƒ…å†µã€‚

```sql
CREATE TABLE IF NOT EXISTS device_activations (
  id SERIAL PRIMARY KEY,
  robot_id VARCHAR(255) NOT NULL UNIQUE,
  robot_uuid VARCHAR(255) NOT NULL UNIQUE,
  device_id VARCHAR(255),
  user_id INTEGER,
  activation_code VARCHAR(8),
  status VARCHAR(20) NOT NULL DEFAULT 'active',
  activated_at TIMESTAMP DEFAULT NOW(),
  expires_at TIMESTAMP,
  last_seen_at TIMESTAMP,
  device_info TEXT,

  -- é…ç½®åŒæ­¥ç›¸å…³
  config_version INTEGER DEFAULT 0,
  config_synced_at TIMESTAMP,
  config_synced BOOLEAN DEFAULT true,
  config_error TEXT,

  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX device_activations_robot_id_idx ON device_activations(robot_id);
CREATE INDEX device_activations_device_id_idx ON device_activations(device_id);
CREATE INDEX device_activations_user_id_idx ON device_activations(user_id);
```

#### 2.1.2 é…ç½®åŒæ­¥æ—¥å¿—è¡¨ (config_sync_logs)

**è¯´æ˜**: è®°å½•é…ç½®æ¨é€å’ŒåŒæ­¥çš„è¯¦ç»†æ—¥å¿—ã€‚

```sql
CREATE TABLE IF NOT EXISTS config_sync_logs (
  id SERIAL PRIMARY KEY,
  robot_id VARCHAR(255) NOT NULL,
  config_version VARCHAR(50) NOT NULL,
  config_data JSONB NOT NULL,
  sync_status VARCHAR(20) NOT NULL DEFAULT 'pending',
  synced_at TIMESTAMP,
  error_message TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX config_sync_logs_robot_id_idx ON config_sync_logs(robot_id);
CREATE INDEX config_sync_logs_status_idx ON config_sync_logs(sync_status);
CREATE INDEX config_sync_logs_version_idx ON config_sync_logs(config_version);
```

#### 2.1.3 æ¶ˆæ¯å‘é€å¤±è´¥æ—¥å¿—è¡¨ (message_fail_logs)

**è¯´æ˜**: è®°å½• APP å‘é€æ¶ˆæ¯åˆ°ç¬¬ä¸‰æ–¹å¹³å°å¤±è´¥çš„æ—¥å¿—ã€‚

```sql
CREATE TABLE IF NOT EXISTS message_fail_logs (
  id SERIAL PRIMARY KEY,
  robot_id VARCHAR(255) NOT NULL,
  message_id VARCHAR(255) NOT NULL,
  third_party_url TEXT NOT NULL,
  error_message TEXT NOT NULL,
  error_type VARCHAR(50),
  retry_count INTEGER DEFAULT 0,
  failed_at TIMESTAMP DEFAULT NOW(),
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX message_fail_logs_robot_id_idx ON message_fail_logs(robot_id);
CREATE INDEX message_fail_logs_message_id_idx ON message_fail_logs(message_id);
CREATE INDEX message_fail_logs_error_type_idx ON message_fail_logs(error_type);
CREATE INDEX message_fail_logs_created_at_idx ON message_fail_logs(created_at);
```

#### 2.1.4 ä¼šè¯è¡¨ (sessions)

**è¯´æ˜**: ç®€åŒ–ç‰ˆä¼šè¯ç®¡ç†ã€‚

```sql
CREATE TABLE IF NOT EXISTS sessions (
  id SERIAL PRIMARY KEY,
  session_id VARCHAR(255) NOT NULL UNIQUE,
  robot_id VARCHAR(255) NOT NULL,
  user_id VARCHAR(255),
  status VARCHAR(20) NOT NULL DEFAULT 'active',
  message_count INTEGER DEFAULT 0,
  last_message_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX sessions_session_id_idx ON sessions(session_id);
CREATE INDEX sessions_robot_id_idx ON sessions(robot_id);
CREATE INDEX sessions_user_id_idx ON sessions(user_id);
```

---

## ä¸‰ã€API æ¥å£å®ç°

### 3.1 è®¾å¤‡é…ç½®æŸ¥è¯¢æ¥å£ï¼ˆå…œåº•æ–¹æ¡ˆï¼‰

**æ¥å£**: `GET /api/device/config`

**è¯·æ±‚å¤´**:
```
Authorization: Bearer {token}
X-Robot-Id: {robotId}
```

**å“åº”**:
```json
{
  "success": true,
  "data": {
    "worktoolApiUrl": "https://api.dify.ai/callback",
    "resultCallbackUrl": "https://api.worktool.ymdyes.cn/wework/sendRawMessage",
    "robotId": "wt22phhjpt2xboerspxsote472xdnyq2",
    "secretKey": "secret_xxx",
    "updatedAt": 1739085600000,
    "version": "1.0"
  }
}
```

**å®ç°æ–‡ä»¶**: `src/app/api/device/config/route.ts`

### 3.2 ç¬¬ä¸‰æ–¹å›è°ƒç»Ÿä¸€æ¥å£

**æ¥å£**: `POST /api/third-party/callback/{type}`

**æ”¯æŒçš„ç±»å‹**:
- `message`: æ¶ˆæ¯å›è°ƒ
- `result`: ç»“æœå›è°ƒ
- `qrcode`: äºŒç»´ç å›è°ƒ
- `online`: ä¸Šçº¿å›è°ƒ
- `offline`: ä¸‹çº¿å›è°ƒ
- `image`: å›¾ç‰‡å›è°ƒ

**ç¤ºä¾‹**: `POST /api/third-party/callback/message?robotId=wt22phhjpt2xboerspxsote472xdnyq2`

**è¯·æ±‚ä½“**:
```json
{
  "messageId": "msg_xxx",
  "senderId": "wxid_xxx",
  "senderName": "å¼ ä¸‰",
  "messageType": "text",
  "content": "ä½ å¥½",
  "chatType": "group",
  "extraData": null,
  "timestamp": "2026-02-09T10:05:03.000Z"
}
```

**å“åº”**:
```json
{
  "code": 200,
  "message": "æ¶ˆæ¯æ¥æ”¶æˆåŠŸ",
  "data": {
    "messageId": "msg_xxx",
    "robotId": "wt22phhjpt2xboerspxsote472xdnyq2",
    "receivedAt": "2026-02-09T10:05:03.000Z"
  }
}
```

**å®ç°æ–‡ä»¶**: `src/app/api/third-party/callback/[type]/route.ts`

### 3.3 æ¶ˆæ¯å›é€€æ¥å£

**æ¥å£**: `POST /api/third-party/fallback/message`

**è¯·æ±‚å¤´**:
```
Authorization: Bearer {token}
X-Robot-Id: {robotId}
```

**è¯·æ±‚ä½“**:
```json
{
  "robotId": "wt22phhjpt2xboerspxsote472xdnyq2",
  "content": "ä½ å¥½",
  "messageType": "text",
  "senderId": "wxid_xxx",
  "senderName": "å¼ ä¸‰"
}
```

**å“åº”**:
```json
{
  "success": true,
  "data": {
    "messageId": "msg_xxx",
    "replyContent": "æ‚¨å¥½ï¼æˆ‘æ˜¯ AI åŠ©æ‰‹ï¼Œå¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡~",
    "isFallback": true
  }
}
```

**å®ç°æ–‡ä»¶**: `src/app/api/third-party/fallback/message/route.ts`

### 3.4 æœºå™¨äººé…ç½®ç®¡ç†æ¥å£

**æ¥å£**: `GET /api/robots/[robotId]/config`

**å“åº”**:
```json
{
  "success": true,
  "data": {
    "robotId": "wt22phhjpt2xboerspxsote472xdnyq2",
    "thirdPartyCallbackUrl": "https://api.dify.ai/callback",
    "thirdPartyResultCallbackUrl": "https://api.worktool.ymdyes.cn/wework/sendRawMessage",
    "thirdPartySecretKey": "secret_xxx",
    "updatedAt": "2026-02-09T10:00:00.000Z"
  }
}
```

**æ¥å£**: `PUT /api/robots/[robotId]/config`

**è¯·æ±‚ä½“**:
```json
{
  "thirdPartyCallbackUrl": "https://api.dify.ai/callback",
  "thirdPartyResultCallbackUrl": "https://api.worktool.ymdyes.cn/wework/sendRawMessage",
  "thirdPartySecretKey": "secret_xxx"
}
```

**å“åº”**:
```json
{
  "success": true,
  "message": "é…ç½®å·²æ›´æ–°"
}
```

**å®ç°æ–‡ä»¶**: `src/app/api/robots/[robotId]/config/route.ts`

### 3.5 é…ç½®åŒæ­¥çŠ¶æ€æŸ¥è¯¢æ¥å£

**æ¥å£**: `GET /api/robots/[robotId]/config-status`

**å“åº”**:
```json
{
  "success": true,
  "data": {
    "robotId": "wt22phhjpt2xboerspxsote472xdnyq2",
    "deviceId": "device_xxx",
    "configVersion": 1,
    "configSyncedAt": "2026-02-09T10:01:00.000Z",
    "configSynced": true,
    "configError": null,
    "status": "synced"
  }
}
```

**å®ç°æ–‡ä»¶**: `src/app/api/robots/[robotId]/config-status/route.ts`

### 3.6 æ¶ˆæ¯æ—¥å¿—ä¸ŠæŠ¥æ¥å£

**æ¥å£**: `POST /api/worktool/message-log`

**è¯·æ±‚ä½“**:
```json
{
  "messageId": "msg_xxx",
  "robotId": "wt22phhjpt2xboerspxsote472xdnyq2",
  "thirdPartyUrl": "https://api.dify.ai/callback",
  "status": "success",
  "error": null,
  "reportedAt": "2026-02-09T10:05:03.000Z"
}
```

**å“åº”**:
```json
{
  "success": true,
  "message": "æ—¥å¿—å·²è®°å½•"
}
```

**å®ç°æ–‡ä»¶**: `src/app/api/worktool/message-log/route.ts`

---

## å››ã€WebSocket åè®®æ‰©å±•

### 4.1 æ–°å¢æ¶ˆæ¯ç±»å‹

#### 4.1.1 é…ç½®æ¨é€æ¶ˆæ¯ (config_push)

**æœåŠ¡å™¨ â†’ APP**

```json
{
  "type": "config_push",
  "data": {
    "worktoolApiUrl": "https://api.dify.ai/callback",
    "resultCallbackUrl": "https://api.worktool.ymdyes.cn/wework/sendRawMessage",
    "robotId": "wt22phhjpt2xboerspxsote472xdnyq2",
    "secretKey": "secret_xxx",
    "updatedAt": 1739085600000,
    "version": "1.0"
  },
  "timestamp": 1739085600000
}
```

#### 4.1.2 é…ç½®ç¡®è®¤æ¶ˆæ¯ (config_ack)

**APP â†’ æœåŠ¡å™¨**

```json
{
  "type": "config_ack",
  "data": {
    "robotId": "wt22phhjpt2xboerspxsote472xdnyq2",
    "configVersion": "1.0",
    "ackTime": "2026-02-09T10:01:00.000Z"
  },
  "timestamp": 1739085660000
}
```

#### 4.1.3 é…ç½®æ‹’ç»æ¶ˆæ¯ (config_nack)

**APP â†’ æœåŠ¡å™¨**

```json
{
  "type": "config_nack",
  "data": {
    "robotId": "wt22phhjpt2xboerspxsote472xdnyq2",
    "configVersion": "1.0",
    "error": "ä¿å­˜é…ç½®å¤±è´¥",
    "nackTime": "2026-02-09T10:01:00.000Z"
  },
  "timestamp": 1739085660000
}
```

#### 4.1.4 æ¶ˆæ¯å›è°ƒæ¶ˆæ¯ (callback)

**æœåŠ¡å™¨ â†’ APP**

```json
{
  "type": "callback",
  "data": {
    "event": "message",
    "messageId": "msg_xxx",
    "robotId": "wt22phhjpt2xboerspxsote472xdnyq2",
    "senderId": "wxid_xxx",
    "senderName": "å¼ ä¸‰",
    "messageType": "text",
    "content": "ä½ å¥½",
    "chatType": "group",
    "extraData": null,
    "timestamp": "2026-02-09T10:05:03.000Z"
  },
  "timestamp": 1739085903000
}
```

#### 4.1.5 æ¶ˆæ¯æ—¥å¿—ä¸ŠæŠ¥æ¶ˆæ¯ (message_log)

**APP â†’ æœåŠ¡å™¨**

```json
{
  "type": "message_log",
  "data": {
    "messageId": "msg_xxx",
    "robotId": "wt22phhjpt2xboerspxsote472xdnyq2",
    "thirdPartyUrl": "https://api.dify.ai/callback",
    "status": "success",
    "error": null,
    "reportedAt": "2026-02-09T10:05:03.000Z"
  },
  "timestamp": 1739085903000
}
```

### 4.2 WebSocket æ¶ˆæ¯å¤„ç†å®ç°

**å®ç°æ–‡ä»¶**: `src/server/websocket/message-handler.ts`

**éœ€è¦æ–°å¢çš„å¤„ç†å‡½æ•°**:
- `handleConfigAck()` - å¤„ç†é…ç½®ç¡®è®¤
- `handleConfigNack()` - å¤„ç†é…ç½®æ‹’ç»
- `handleMessageLog()` - å¤„ç†æ¶ˆæ¯æ—¥å¿—ä¸ŠæŠ¥
- `pushConfigToRobot()` - æ¨é€é…ç½®åˆ°æœºå™¨äºº

---

## äº”ã€å®æ–½è®¡åˆ’

### 5.1 å®æ–½é˜¶æ®µ

#### é˜¶æ®µä¸€ï¼šæ•°æ®åº“å‡†å¤‡ï¼ˆ1å¤©ï¼‰

**ä»»åŠ¡æ¸…å•**:
- âœ… åˆ›å»º `device_activations` è¡¨
- âœ… åˆ›å»º `config_sync_logs` è¡¨
- âœ… åˆ›å»º `message_fail_logs` è¡¨
- âœ… åˆ›å»º `sessions` è¡¨
- âœ… æ·»åŠ ç´¢å¼•
- âœ… æ•°æ®è¿ç§»ï¼ˆå¦‚æœæœ‰æ—§æ•°æ®ï¼‰

**æ–‡ä»¶**: `src/db/migrations/create-third-party-integration-tables.sql`

---

#### é˜¶æ®µäºŒï¼šAPI æ¥å£å¼€å‘ï¼ˆ2å¤©ï¼‰

**ä»»åŠ¡æ¸…å•**:
1. âœ… å®ç° `/api/device/config` æ¥å£
2. âœ… å®ç° `/api/third-party/callback/[type]/` æ¥å£
3. âœ… å®ç° `/api/third-party/fallback/message` æ¥å£
4. âœ… å®ç° `/api/robots/[robotId]/config` æ¥å£
5. âœ… å®ç° `/api/robots/[robotId]/config-status` æ¥å£
6. âœ… å®ç° `/api/worktool/message-log` æ¥å£

**æ–‡ä»¶**:
- `src/app/api/device/config/route.ts`
- `src/app/api/third-party/callback/[type]/route.ts`
- `src/app/api/third-party/fallback/message/route.ts`
- `src/app/api/robots/[robotId]/config/route.ts`
- `src/app/api/robots/[robotId]/config-status/route.ts`
- `src/app/api/worktool/message-log/route.ts`

---

#### é˜¶æ®µä¸‰ï¼šWebSocket åè®®æ‰©å±•ï¼ˆ1å¤©ï¼‰

**ä»»åŠ¡æ¸…å•**:
1. âœ… æ‰©å±• WebSocket æ¶ˆæ¯ç±»å‹
2. âœ… å®ç°é…ç½®æ¨é€é€»è¾‘
3. âœ… å®ç°é…ç½®ç¡®è®¤/æ‹’ç»å¤„ç†
4. âœ… å®ç°æ¶ˆæ¯å›è°ƒæ¨é€
5. âœ… å®ç°æ¶ˆæ¯æ—¥å¿—ä¸ŠæŠ¥å¤„ç†
6. âœ… æµ‹è¯• WebSocket é€šä¿¡

**æ–‡ä»¶**:
- `src/server/websocket/types.ts` - æ‰©å±•æ¶ˆæ¯ç±»å‹å®šä¹‰
- `src/server/websocket/message-handler.ts` - æ–°å¢æ¶ˆæ¯å¤„ç†å‡½æ•°
- `src/server/websocket-server-v3.ts` - æ–°å¢é…ç½®æ¨é€è§¦å‘æ—¶æœº

---

#### é˜¶æ®µå››ï¼šç³»ç»Ÿé›†æˆæµ‹è¯•ï¼ˆ2å¤©ï¼‰

**ä»»åŠ¡æ¸…å•**:
1. âœ… é…ç½®åŒæ­¥æµç¨‹æµ‹è¯•
2. âœ… æ¶ˆæ¯å‘é€æµç¨‹æµ‹è¯•
3. âœ… å›é€€æœºåˆ¶æµ‹è¯•
4. âœ… å¼‚å¸¸æƒ…å†µæµ‹è¯•
5. âœ… æ€§èƒ½æµ‹è¯•
6. âœ… å‹åŠ›æµ‹è¯•

**æµ‹è¯•ç”¨ä¾‹**:
- é…ç½®æ¨é€å’Œç¡®è®¤
- æ¶ˆæ¯å‘é€åˆ°ç¬¬ä¸‰æ–¹å¹³å°
- ç¬¬ä¸‰æ–¹å¹³å°è°ƒç”¨ WorkBot API
- æ¶ˆæ¯å›é€€åˆ°ä¸»æœåŠ¡å™¨
- é…ç½®åŒæ­¥å¤±è´¥é‡è¯•
- WebSocket è¿æ¥å¼‚å¸¸

---

#### é˜¶æ®µäº”ï¼šæ–‡æ¡£ç¼–å†™ï¼ˆ1å¤©ï¼‰

**ä»»åŠ¡æ¸…å•**:
1. âœ… æ›´æ–° API æ–‡æ¡£
2. âœ… æ›´æ–° WebSocket åè®®æ–‡æ¡£
3. âœ… ç¼–å†™æ•°æ®åº“è®¾è®¡æ–‡æ¡£
4. âœ… ç¼–å†™éƒ¨ç½²æŒ‡å—
5. âœ… ç¼–å†™æ•…éšœæ’æŸ¥æŒ‡å—

---

#### é˜¶æ®µå…­ï¼šéƒ¨ç½²ä¸Šçº¿ï¼ˆ1å¤©ï¼‰

**ä»»åŠ¡æ¸…å•**:
1. âœ… å¤‡ä»½æ•°æ®åº“
2. âœ… æ‰§è¡Œæ•°æ®åº“è¿ç§»
3. âœ… éƒ¨ç½²æ–°ç‰ˆæœ¬
4. âœ… éªŒè¯éƒ¨ç½²ç»“æœ
5. âœ… ç›‘æ§è¿è¡ŒçŠ¶æ€

---

### 5.2 ä¼˜å…ˆçº§æ’åº

| ä¼˜å…ˆçº§ | åŠŸèƒ½ | å¤©æ•° | ä¾èµ– |
|--------|------|------|------|
| ğŸ”´ é«˜ | æ•°æ®åº“å‡†å¤‡ | 1å¤© | æ—  |
| ğŸ”´ é«˜ | API æ¥å£å¼€å‘ | 2å¤© | æ•°æ®åº“å‡†å¤‡ |
| ğŸ”´ é«˜ | WebSocket åè®®æ‰©å±• | 1å¤© | API æ¥å£å¼€å‘ |
| ğŸŸ¡ ä¸­ | ç³»ç»Ÿé›†æˆæµ‹è¯• | 2å¤© | WebSocket åè®®æ‰©å±• |
| ğŸŸ¡ ä¸­ | æ–‡æ¡£ç¼–å†™ | 1å¤© | ç³»ç»Ÿé›†æˆæµ‹è¯• |
| ğŸ”´ é«˜ | éƒ¨ç½²ä¸Šçº¿ | 1å¤© | æ–‡æ¡£ç¼–å†™ |

**æ€»æ—¶é—´**: 8å¤©

---

## å…­ã€å…³é”®ä»£ç ç¤ºä¾‹

### 6.1 è®¾å¤‡æ¿€æ´»æ¥å£ï¼ˆä¿®æ”¹åï¼‰

```typescript
// src/app/api/robot-ids/activate/route.ts

export async function POST(request: NextRequest) {
  const client = await pool.connect();
  try {
    const body = await request.json();
    const { code, deviceInfo } = activateSchema.parse(body);

    // 1. éªŒè¯æ¿€æ´»ç 
    const codeResult = await client.query(
      `SELECT * FROM activation_codes WHERE code = $1 LIMIT 1`,
      [code.toUpperCase()]
    );

    if (codeResult.rows.length === 0) {
      return NextResponse.json({ code: 400, message: "æ¿€æ´»ç æ— æ•ˆ" }, { status: 400 });
    }

    const activationCode = codeResult.rows[0];

    // 2. ç”Ÿæˆæœºå™¨äººIDå’ŒUUID
    const robotId = generateRobotId();
    const robotUuid = generateUUID();
    const token = generateToken();

    // 3. åˆ›å»º/æ›´æ–° device_activations è®°å½• â­
    await client.query(`
      INSERT INTO device_activations (
        robot_id, robot_uuid, device_id, user_id,
        activation_code, status, activated_at, device_info
      )
      VALUES ($1, $2, $3, $4, $5, 'active', NOW(), $6)
      ON CONFLICT (robot_id) DO UPDATE SET
        last_seen_at = NOW(),
        updated_at = NOW()
    `, [
      robotId,
      robotUuid,
      deviceInfo.deviceId,
      activationCode.bound_user_id,
      activationCode.code,
      JSON.stringify(deviceInfo)
    ]);

    // 4. æŸ¥è¯¢æœºå™¨äººé…ç½® â­
    const robotResult = await client.query(`
      SELECT
        third_party_callback_url,
        third_party_result_callback_url,
        third_party_secret_key,
        EXTRACT(EPOCH FROM updated_at) * 1000 as updated_at_timestamp
      FROM robots
      WHERE robot_id = $1
      LIMIT 1
    `, [robotId]);

    // 5. é€šè¿‡ WebSocket æ¨é€é…ç½® â­
    if (robotResult.rows.length > 0) {
      const robot = robotResult.rows[0];
      const connection = connectionManager.getConnection(robotId);

      if (connection) {
        sendMessage(connection, {
          type: 'config_push',
          data: {
            worktoolApiUrl: robot.third_party_callback_url,
            resultCallbackUrl: robot.third_party_result_callback_url,
            robotId: robotId,
            secretKey: robot.third_party_secret_key,
            updatedAt: robot.updated_at_timestamp,
            version: '1.0'
          },
          timestamp: Date.now()
        });

        // è®°å½•æ¨é€æ—¥å¿—
        await client.query(`
          INSERT INTO config_sync_logs (
            robot_id, config_version, config_data, sync_status, created_at
          )
          VALUES ($1, '1.0', $2, 'pending', NOW())
        `, [
          robotId,
          JSON.stringify({
            worktoolApiUrl: robot.third_party_callback_url,
            resultCallbackUrl: robot.third_party_result_callback_url,
            robotId: robotId,
            secretKey: robot.third_party_secret_key,
            updatedAt: robot.updated_at_timestamp,
            version: '1.0'
          })
        ]);
      }
    }

    // 6. è¿”å› Token
    return NextResponse.json({
      code: 201,
      data: {
        robotId,
        robotUuid,
        token,
        expiresIn: 86400
      }
    });

  } catch (error) {
    console.error('æ¿€æ´»å¤±è´¥:', error);
    return NextResponse.json(
      { code: 500, message: "æ¿€æ´»å¤±è´¥" },
      { status: 500 }
    );
  } finally {
    client.release();
  }
}
```

### 6.2 ç¬¬ä¸‰æ–¹å›è°ƒæ¥å£å®ç°

```typescript
// src/app/api/third-party/callback/[type]/route.ts

export async function POST(
  request: NextRequest,
  { params }: { params: { type: string } }
) {
  try {
    const type = params.type;
    const robotId = request.nextUrl.searchParams.get('robotId');

    if (!robotId) {
      return NextResponse.json(
        { code: 400, message: 'ç¼ºå°‘æœºå™¨äººID' },
        { status: 400 }
      );
    }

    const body = await request.json();

    console.log(`[ThirdParty] æ”¶åˆ°å›è°ƒ: type=${type}, robotId=${robotId}`);

    // æ ¹æ®å›è°ƒç±»å‹å¤„ç†
    switch (type) {
      case 'message':
        return await handleMessageCallback(robotId, body);
      case 'result':
        return await handleResultCallback(robotId, body);
      case 'qrcode':
        return await handleQRCodeCallback(robotId, body);
      case 'online':
      case 'offline':
        return await handleStatusCallback(robotId, body, type);
      case 'image':
        return await handleImageCallback(robotId, body);
      default:
        return NextResponse.json(
          { code: 400, message: `æœªçŸ¥çš„å›è°ƒç±»å‹: ${type}` },
          { status: 400 }
        );
    }
  } catch (error) {
    console.error('[ThirdParty] å¤„ç†å›è°ƒå¤±è´¥:', error);
    return NextResponse.json(
      { code: 500, message: 'å¤„ç†å›è°ƒå¤±è´¥' },
      { status: 500 }
    );
  }
}

// å¤„ç†ç»“æœå›è°ƒï¼ˆç¬¬ä¸‰æ–¹å¹³å°è°ƒç”¨ WorkBot å‘é€å›å¤ï¼‰
async function handleResultCallback(robotId: string, body: any) {
  const client = await pool.connect();
  try {
    // 1. éªŒè¯æœºå™¨äºº
    const robotResult = await client.query(
      `SELECT id FROM robots WHERE robot_id = $1 LIMIT 1`,
      [robotId]
    );

    if (robotResult.rows.length === 0) {
      return NextResponse.json(
        { code: 404, message: 'æœºå™¨äººä¸å­˜åœ¨' },
        { status: 404 }
      );
    }

    // 2. æå–æ¶ˆæ¯å†…å®¹
    const { content, target, messageType = 'text' } = body;

    if (!content || !target) {
      return NextResponse.json(
        { code: 400, message: 'ç¼ºå°‘å¿…è¦å‚æ•°ï¼šcontent æˆ– target' },
        { status: 400 }
      );
    }

    // 3. é€šè¿‡ WebSocket æ¨é€ç»™ APP
    const connection = connectionManager.getConnection(robotId);

    if (!connection) {
      return NextResponse.json(
        { code: 503, message: 'æœºå™¨äººæœªè¿æ¥' },
        { status: 503 }
      );
    }

    const commandId = `cmd_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

    sendMessage(connection, {
      type: 'command_push',
      data: {
        commandId,
        commandType: 203, // å‘é€æ¶ˆæ¯æŒ‡ä»¤
        params: {
          target,
          content,
          messageType
        }
      },
      timestamp: Date.now()
    });

    console.log(`[ThirdParty] æŒ‡ä»¤å·²æ¨é€ç»™ APP: ${robotId}, æŒ‡ä»¤: ${commandId}`);

    return NextResponse.json({
      code: 200,
      message: 'æŒ‡ä»¤å·²ä¸‹å‘',
      data: {
        commandId,
        robotId,
        status: 'pending'
      }
    });

  } catch (error) {
    console.error('[ThirdParty] å¤„ç†ç»“æœå›è°ƒå¤±è´¥:', error);
    throw error;
  } finally {
    client.release();
  }
}
```

### 6.3 æ¶ˆæ¯å›é€€æ¥å£å®ç°

```typescript
// src/app/api/third-party/fallback/message/route.ts

export async function POST(request: NextRequest) {
  const client = await pool.connect();
  try {
    // 1. éªŒè¯ Token
    const authHeader = request.headers.get('authorization');
    if (!authHeader?.startsWith('Bearer ')) {
      return NextResponse.json(
        { success: false, error: 'ç¼ºå°‘è®¤è¯ä¿¡æ¯' },
        { status: 401 }
      );
    }

    const token = authHeader.replace('Bearer ', '');
    const payload = verifyToken(token);

    if (!payload || payload.robotId !== robotId) {
      return NextResponse.json(
        { success: false, error: 'Token æ— æ•ˆ' },
        { status: 401 }
      );
    }

    // 2. è§£æè¯·æ±‚ä½“
    const body = await request.json();
    const { robotId, content, messageType, senderId, senderName } = body;

    if (!robotId || !content) {
      return NextResponse.json(
        { success: false, error: 'ç¼ºå°‘å¿…è¦å‚æ•°' },
        { status: 400 }
      );
    }

    // 3. æŸ¥è¯¢æœºå™¨äººé…ç½®
    const robotResult = await client.query(
      `SELECT id, robot_id, ai_mode, ai_provider, ai_model, ai_api_key
       FROM robots WHERE robot_id = $1 LIMIT 1`,
      [robotId]
    );

    if (robotResult.rows.length === 0) {
      return NextResponse.json(
        { success: false, error: 'æœºå™¨äººä¸å­˜åœ¨' },
        { status: 404 }
      );
    }

    const robot = robotResult.rows[0];

    // 4. ä¿å­˜æ¶ˆæ¯åˆ°æ•°æ®åº“
    const messageId = `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    const sessionId = `session_${robotId}_${senderId || 'unknown'}`;

    await client.query(`
      INSERT INTO messages (
        robot_id, user_id, session_id, message_type,
        content, extra_data, status, direction, created_at
      )
      VALUES ($1, $2, $3, $4, $5, $6, 'received', 'incoming', NOW())
    `, [robotId, senderId || null, sessionId, messageType || 'text', content, JSON.stringify(body)]);

    // 5. å¤„ç†æ¶ˆæ¯ï¼ˆä½¿ç”¨å†…ç½® AI æˆ–å…¶ä»–æ–¹å¼ï¼‰
    let replyContent = '';

    if (robot.ai_mode === 'builtin' && robot.ai_api_key) {
      // ä½¿ç”¨å†…ç½® AI ç”Ÿæˆå›å¤
      replyContent = await generateAIReply(content, robot);
    } else {
      // ä½¿ç”¨é»˜è®¤å›å¤
      replyContent = 'æ„Ÿè°¢æ‚¨çš„æ¶ˆæ¯ï¼Œæˆ‘ä»¬ä¼šå°½å¿«å›å¤ã€‚';
    }

    // 6. ä¿å­˜å›å¤åˆ°æ•°æ®åº“
    await client.query(`
      INSERT INTO messages (
        robot_id, user_id, session_id, message_type,
        content, extra_data, status, direction, created_at
      )
      VALUES ($1, $2, $3, $4, $5, $6, 'sent', 'outgoing', NOW())
    `, [robotId, null, sessionId, 'text', replyContent, JSON.stringify({ isFallback: true })]);

    // 7. é€šè¿‡ WebSocket æ¨é€ç»™ APP
    const connection = connectionManager.getConnection(robotId);

    if (connection) {
      sendMessage(connection, {
        type: 'command_push',
        data: {
          commandId: `cmd_${Date.now()}`,
          commandType: 203,
          params: {
            target: senderName || 'ç”¨æˆ·',
            content: replyContent,
            messageType: 'text'
          }
        },
        timestamp: Date.now()
      });
    }

    return NextResponse.json({
      success: true,
      data: {
        messageId,
        replyContent,
        isFallback: true
      }
    });

  } catch (error) {
    console.error('[Fallback] å¤„ç†æ¶ˆæ¯å¤±è´¥:', error);
    return NextResponse.json(
      { success: false, error: 'å¤„ç†æ¶ˆæ¯å¤±è´¥' },
      { status: 500 }
    );
  } finally {
    client.release();
  }
}

// AI å›å¤ç”Ÿæˆå‡½æ•°
async function generateAIReply(content: string, robot: any): Promise<string> {
  // TODO: å®ç°å…·ä½“çš„ AI è°ƒç”¨é€»è¾‘
  // è¿™é‡Œå¯ä»¥è°ƒç”¨è±†åŒ…ã€DeepSeekã€Kimi ç­‰ AI æœåŠ¡
  
  // ç®€åŒ–å®ç°ï¼šè¿”å›å›ºå®šå›å¤
  return `æ‚¨å¥½ï¼æˆ‘æ˜¯ AI åŠ©æ‰‹ï¼Œæ‚¨è¯´"${content}"ï¼Œå¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ï¼`;
}
```

---

## ä¸ƒã€æ€»ç»“

### 7.1 å…³é”®ç‚¹

1. **é…ç½®å­—æ®µæ˜ å°„**:
   - `thirdPartyCallbackUrl` â†’ APP å‘é€æ¶ˆæ¯çš„ç›®æ ‡åœ°å€
   - `thirdPartyResultCallbackUrl` â†’ ç¬¬ä¸‰æ–¹å¹³å°è°ƒç”¨ WorkBot çš„åœ°å€
   - `thirdPartySecretKey` â†’ å¯†é’¥ï¼ˆå¯é€‰ï¼‰

2. **é…ç½®æ¨é€æµç¨‹**:
   - ç®¡ç†å‘˜é…ç½® â†’ ä¿å­˜åˆ°æ•°æ®åº“ â†’ WebSocket æ¨é€ â†’ APP ç¡®è®¤

3. **æ¶ˆæ¯å‘é€æµç¨‹**:
   - APP â†’ ç¬¬ä¸‰æ–¹å¹³å° â†’ WorkBot API â†’ WebSocket â†’ APP

4. **å›é€€æœºåˆ¶**:
   - ç¬¬ä¸‰æ–¹å¹³å°å¤±è´¥ â†’ APP å›é€€åˆ° WorkBot â†’ å†…ç½® AI å¤„ç† â†’ WebSocket â†’ APP

### 7.2 å…¼å®¹æ€§

âœ… **å‘åå…¼å®¹**:
- ç°æœ‰æ¥å£ä¿æŒä¸å˜
- æ–°å¢æ¶ˆæ¯ç±»å‹ä¸å½±å“ç°æœ‰ WebSocket åè®®
- æ•°æ®åº“æ–°å¢è¡¨ä¸å½±å“ç°æœ‰è¡¨

### 7.3 å®æ–½æ—¶é—´

**æ€»æ—¶é—´**: 8å¤©
- æ•°æ®åº“å‡†å¤‡: 1å¤©
- API æ¥å£å¼€å‘: 2å¤©
- WebSocket åè®®æ‰©å±•: 1å¤©
- ç³»ç»Ÿé›†æˆæµ‹è¯•: 2å¤©
- æ–‡æ¡£ç¼–å†™: 1å¤©
- éƒ¨ç½²ä¸Šçº¿: 1å¤©

---

**æ–‡æ¡£ç»“æŸ**
