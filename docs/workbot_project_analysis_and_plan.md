# WorkBot 项目分析与开发计划

> 基于 Next.js 16 + 扣子云平台的企业微信机器人管理系统

---

## 📊 项目现状分析

### 1. 项目概述

**项目名称**：WorkBot 企业微信机器人管理系统  
**当前版本**：v2.0  
**适配平台**：扣子云平台  
**开发状态**：需求分析完成，技术文档完善，准备进入开发阶段

### 2. 系统架构分析

```
┌─────────────────────────────────────────────────────────┐
│                    WorkBot 系统                           │
│                    扣子云平台部署                          │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │  手机APP    │  │  管理后台   │  │  第三方平台 │    │
│  │ (企业微信)  │  │  (Web)      │  │ (Dify/豆包) │    │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘    │
│         │                 │                 │            │
│         │ WSS (5000)      │ HTTPS (5000)    │ HTTPS      │
│         │                 │                 │            │
│         ▼                 ▼                 ▼            │
│  ┌───────────────────────────────────────────────┐     │
│  │    WorkBot 服务器 (Next.js 16)                 │     │
│  │    端口：5000 (HTTP + WebSocket)              │     │
│  └───────────────────┬───────────────────────────┘     │
│                      │                                  │
│        ┌─────────────┼─────────────┐                   │
│        ▼             ▼             ▼                   │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐             │
│  │PostgreSQL│  │PostgreSQL│  │ 对象存储 │             │
│  │  (主库)  │  │ (消息队列)│  │  (S3)   │             │
│  └──────────┘  └──────────┘  └──────────┘             │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

### 3. 技术栈总结

| 组件 | 技术选型 | 说明 |
|------|----------|------|
| **前端框架** | Next.js 16 | React 19, App Router |
| **UI组件库** | shadcn/ui | 基于 Radix UI |
| **样式方案** | Tailwind CSS 4 | 原子化CSS |
| **后端框架** | Next.js 16 API Routes | 全栈框架 |
| **数据库** | PostgreSQL | 主库 + 消息队列 |
| **ORM** | Drizzle ORM | 类型安全的ORM |
| **实时通讯** | WebSocket | 与HTTP共享5000端口 |
| **对象存储** | S3兼容 | 文件存储（Storage技能） |
| **AI服务** | 豆包/DeepSeek/Kimi | LLM能力（LLM技能） |
| **包管理器** | pnpm | 高效的包管理 |
| **部署平台** | 扣子云平台 | 云端部署 |

### 4. 数据库设计分析

**核心表数量**：13张

| 表名 | 用途 | 记录量预估 |
|------|------|------------|
| users | 用户信息 | 1万+ |
| activation_codes | 激活码 | 10万+ |
| device_activations | 设备激活记录 | 10万+ |
| device_unbindings | 设备解绑历史 | 5万+ |
| activation_logs | 激活日志 | 50万+ |
| robots | 机器人配置 | 3万+ |
| messages | 消息记录 | 1000万+ |
| sessions | 会话管理 | 50万+ |
| session_contexts | 会话上下文 | 500万+ |
| commands | 指令记录 | 100万+ |
| system_logs | 系统日志 | 1000万+ |
| orders | 订单记录 | 10万+ |
| third_party_configs | 第三方配置 | 3万+ |

---

## 🎯 功能模块分析

### 1. 用户管理模块

**核心功能**：
- ✅ 手机号+短信验证码登录
- ✅ 用户角色管理（超级管理员/普通用户）
- ✅ 用户信息管理
- ✅ 用户权限控制

**技术要点**：
- 阿里云短信服务
- JWT Token认证
- Redis Session管理

### 2. 激活码管理模块

**核心功能**：
- ✅ 管理员批量生成激活码
- ✅ 用户在线购买激活码
- ✅ 一码一设备机制
- ✅ 设备解绑功能（管理员）
- ✅ 激活码状态管理

**技术要点**：
- 激活码生成算法（8位，不含I/O，不含0/1）
- deviceId识别（Android: ANDROID_ID, iOS: identifierForVendor）
- 设备绑定验证
- 激活日志追踪

### 3. 机器人管理模块

**核心功能**：
- ✅ 机器人CRUD（最多30个/用户）
- ✅ AI回复模式选择（内置AI/第三方平台）
- ✅ AI模型配置（豆包/DeepSeek/Kimi）
- ✅ 机器人状态管理（在线/离线/已删除）
- ✅ 机器人配置管理

**技术要点**：
- 机器人状态实时更新
- WebSocket心跳机制
- AI调用限流（每日限制）

### 4. 消息处理模块

**核心功能**：
- ✅ APP接收企业微信消息
- ✅ 消息上报到服务器
- ✅ 消息转发到第三方AI平台
- ✅ AI回复下发到APP
- ✅ 消息会话管理
- ✅ 消息历史记录

**技术要点**：
- 消息队列（PostgreSQL）
- 会话上下文管理
- 消息类型识别（20+种）
- 收藏消息支持（type=900）

### 5. 第三方集成模块

**核心功能**：
- ✅ 消息回调接口
- ✅ 结果回调接口
- ✅ 群二维码回调接口
- ✅ 状态回调接口
- ✅ 第三方配置管理
- ✅ 回调签名验证

**技术要点**：
- 回调超时控制（3秒）
- 自动重试机制（3次）
- 签名验证（HMAC-SHA256）
- 回调日志记录

### 6. 支付系统模块

**核心功能**：
- ✅ 在线购买激活码
- ✅ 微信支付集成
- ✅ 订单管理
- ✅ 支付状态追踪

**技术要点**：
- 微信支付SDK
- 订单状态机
- 支付回调处理

### 7. WebSocket通讯模块

**核心功能**：
- ✅ WebSocket连接管理
- ✅ 指令推送
- ✅ 心跳机制
- ✅ 连接状态监控

**技术要点**：
- 与HTTP共享5000端口
- 心跳间隔30秒
- 超时判定60秒

### 8. 系统监控模块

**核心功能**：
- ✅ 机器人在线率监控
- ✅ 消息处理成功率监控
- ✅ AI调用成功率监控
- ✅ API响应时间监控
- ✅ 系统日志管理
- ✅ 告警通知

**技术要点**：
- 6种日志类型
- 日志分级保留（7天-永久）
- 告警规则配置

---

## 📅 开发计划

### 第一阶段：基础架构搭建（2周）

**目标**：完成项目初始化和基础架构

**任务列表**：

| 序号 | 任务 | 预计时间 | 负责人 | 状态 |
|------|------|----------|--------|------|
| 1.1 | 使用 coze init 初始化 Next.js 项目 | 0.5天 | 开发者 | 待开始 |
| 1.2 | 配置 TypeScript 和 ESLint | 0.5天 | 开发者 | 待开始 |
| 1.3 | 安装 shadcn/ui 组件库 | 0.5天 | 开发者 | 待开始 |
| 1.4 | 配置 Tailwind CSS 4 | 0.5天 | 开发者 | 待开始 |
| 1.5 | 配置 Drizzle ORM | 1天 | 开发者 | 待开始 |
| 1.6 | 创建数据库表结构（13张表） | 2天 | 开发者 | 待开始 |
| 1.7 | 创建基础页面框架（布局、导航） | 1天 | 前端 | 待开始 |
| 1.8 | 配置环境变量 | 0.5天 | 开发者 | 待开始 |
| 1.9 | 配置扣子云平台部署 | 1天 | 运维 | 待开始 |

**交付物**：
- ✅ 项目初始化完成
- ✅ 数据库表结构创建
- ✅ 基础页面框架
- ✅ 开发环境配置完成

### 第二阶段：用户管理系统（1周）

**目标**：完成用户注册、登录、权限管理

**任务列表**：

| 序号 | 任务 | 预计时间 | 负责人 | 状态 |
|------|------|----------|--------|------|
| 2.1 | 开发短信验证码发送接口 | 1天 | 后端 | 待开始 |
| 2.2 | 开发手机号登录/注册接口 | 1天 | 后端 | 待开始 |
| 2.3 | 开发JWT Token认证中间件 | 0.5天 | 后端 | 待开始 |
| 2.4 | 开发用户信息管理接口 | 0.5天 | 后端 | 待开始 |
| 2.5 | 开发登录页面 | 1天 | 前端 | 待开始 |
| 2.6 | 开发用户管理页面（管理员） | 1天 | 前端 | 待开始 |
| 2.7 | 单元测试 | 1天 | 测试 | 待开始 |

**交付物**：
- ✅ 用户登录/注册功能
- ✅ 用户信息管理功能
- ✅ 权限控制中间件

### 第三阶段：激活码管理系统（1.5周）

**目标**：完成激活码生成、购买、激活、解绑功能

**任务列表**：

| 序号 | 任务 | 预计时间 | 负责人 | 状态 |
|------|------|----------|--------|------|
| 3.1 | 开发激活码生成接口（管理员） | 1天 | 后端 | 待开始 |
| 3.2 | 开发激活码列表接口 | 0.5天 | 后端 | 待开始 |
| 3.3 | 开发激活码激活接口（APP） | 1天 | 后端 | 待开始 |
| 3.4 | 开发Token刷新接口 | 0.5天 | 后端 | 待开始 |
| 3.5 | 开发设备解绑接口（管理员） | 1天 | 后端 | 待开始 |
| 3.6 | 开发激活码管理页面 | 2天 | 前端 | 待开始 |
| 3.7 | 开发激活码购买页面（用户） | 1天 | 前端 | 待开始 |
| 3.8 | 集成微信支付 | 1.5天 | 后端 | 待开始 |
| 3.9 | 单元测试和集成测试 | 1天 | 测试 | 待开始 |

**交付物**：
- ✅ 激活码生成功能
- ✅ 激活码激活功能（一码一设备）
- ✅ 激活码购买功能
- ✅ 设备解绑功能
- ✅ 微信支付集成

### 第四阶段：机器人管理系统（1.5周）

**目标**：完成机器人CRUD、配置管理、状态监控

**任务列表**：

| 序号 | 任务 | 预计时间 | 负责人 | 状态 |
|------|------|----------|--------|------|
| 4.1 | 开发机器人CRUD接口 | 1天 | 后端 | 待开始 |
| 4.2 | 开发机器人配置接口 | 1天 | 后端 | 待开始 |
| 4.3 | 开发机器人列表接口 | 0.5天 | 后端 | 待开始 |
| 4.4 | 开发机器人详情接口 | 0.5天 | 后端 | 待开始 |
| 4.5 | 开发机器人统计接口 | 0.5天 | 后端 | 待开始 |
| 4.6 | 开发机器人管理页面 | 2天 | 前端 | 待开始 |
| 4.7 | 开发机器人配置页面 | 1天 | 前端 | 待开始 |
| 4.8 | 集成LLM技能（豆包/DeepSeek/Kimi） | 1.5天 | 后端 | 待开始 |
| 4.9 | 单元测试 | 1天 | 测试 | 待开始 |

**交付物**：
- ✅ 机器人CRUD功能
- ✅ 机器人配置功能
- ✅ AI模型配置功能
- ✅ LLM技能集成

### 第五阶段：消息处理系统（2周）

**目标**：完成消息接收、转发、下发、回调功能

**任务列表**：

| 序号 | 任务 | 预计时间 | 负责人 | 状态 |
|------|------|----------|--------|------|
| 5.1 | 开发消息上报接口（APP） | 1天 | 后端 | 待开始 |
| 5.2 | 开发消息发送接口 | 1天 | 后端 | 待开始 |
| 5.3 | 开发消息队列（PostgreSQL） | 1天 | 后端 | 待开始 |
| 5.4 | 开发会话管理功能 | 1天 | 后端 | 待开始 |
| 5.5 | 开发会话上下文管理 | 1天 | 后端 | 待开始 |
| 5.6 | 开发消息记录查询接口 | 0.5天 | 后端 | 待开始 |
| 5.7 | 实现20+种消息类型支持 | 2天 | 后端 | 待开始 |
| 5.8 | 开发消息历史页面 | 1.5天 | 前端 | 待开始 |
| 5.9 | 单元测试和集成测试 | 1.5天 | 测试 | 待开始 |

**交付物**：
- ✅ 消息上报功能
- ✅ 消息发送功能
- ✅ 消息队列
- ✅ 会话管理
- ✅ 20+种消息类型支持

### 第六阶段：第三方集成模块（1.5周）

**目标**：完成第三方平台回调接口和配置管理

**任务列表**：

| 序号 | 任务 | 预计时间 | 负责人 | 状态 |
|------|------|----------|--------|------|
| 6.1 | 开发消息回调转发接口 | 1天 | 后端 | 待开始 |
| 6.2 | 开发结果回调接口 | 0.5天 | 后端 | 待开始 |
| 6.3 | 实现回调超时控制 | 0.5天 | 后端 | 待开始 |
| 6.4 | 实现自动重试机制（3次） | 0.5天 | 后端 | 待开始 |
| 6.5 | 实现回调签名验证 | 0.5天 | 后端 | 待开始 |
| 6.6 | 开发第三方配置管理接口 | 0.5天 | 后端 | 待开始 |
| 6.7 | 开发第三方配置页面 | 1天 | 前端 | 待开始 |
| 6.8 | 单元测试 | 1天 | 测试 | 待开始 |

**交付物**：
- ✅ 消息回调功能
- ✅ 结果回调功能
- ✅ 回调超时控制
- ✅ 自动重试机制
- ✅ 签名验证

### 第七阶段：WebSocket通讯模块（1周）

**目标**：完成WebSocket连接管理和指令推送

**任务列表**：

| 序号 | 任务 | 预计时间 | 负责人 | 状态 |
|------|------|----------|--------|------|
| 7.1 | 搭建WebSocket服务器 | 1天 | 后端 | 待开始 |
| 7.2 | 实现连接管理功能 | 0.5天 | 后端 | 待开始 |
| 7.3 | 实现心跳机制 | 0.5天 | 后端 | 待开始 |
| 7.4 | 实现指令推送功能 | 1天 | 后端 | 待开始 |
| 7.5 | 实现连接状态监控 | 0.5天 | 后端 | 待开始 |
| 7.6 | 开发WebSocket客户端（APP端） | 1.5天 | APP开发 | 待开始 |
| 7.7 | 单元测试和集成测试 | 1天 | 测试 | 待开始 |

**交付物**：
- ✅ WebSocket服务器
- ✅ 连接管理
- ✅ 心跳机制
- ✅ 指令推送
- ✅ WebSocket客户端

### 第八阶段：系统监控模块（1周）

**目标**：完成日志管理、监控告警功能

**任务列表**：

| 序号 | 任务 | 预计时间 | 负责人 | 状态 |
|------|------|----------|--------|------|
| 8.1 | 开发日志收集中间件 | 0.5天 | 后端 | 待开始 |
| 8.2 | 开发日志查询接口 | 0.5天 | 后端 | 待开始 |
| 8.3 | 实现日志自动清理任务 | 0.5天 | 后端 | 待开始 |
| 8.4 | 开发监控指标收集 | 0.5天 | 后端 | 待开始 |
| 8.5 | 开发告警规则配置 | 0.5天 | 后端 | 待开始 |
| 8.6 | 开发监控大盘页面 | 2天 | 前端 | 待开始 |
| 8.7 | 开发日志查询页面 | 1天 | 前端 | 待开始 |
| 8.8 | 单元测试 | 0.5天 | 测试 | 待开始 |

**交付物**：
- ✅ 日志收集系统
- ✅ 日志查询功能
- ✅ 日志自动清理
- ✅ 监控指标收集
- ✅ 告警规则
- ✅ 监控大盘

### 第九阶段：测试与优化（1.5周）

**目标**：完成全流程测试和性能优化

**任务列表**：

| 序号 | 任务 | 预计时间 | 负责人 | 状态 |
|------|------|----------|--------|------|
| 9.1 | 功能测试 | 2天 | 测试 | 待开始 |
| 9.2 | 性能测试 | 1天 | 测试 | 待开始 |
| 9.3 | 压力测试 | 1天 | 测试 | 待开始 |
| 9.4 | 安全测试 | 1天 | 测试 | 待开始 |
| 9.5 | Bug修复 | 1.5天 | 开发者 | 待开始 |
| 9.6 | 性能优化 | 0.5天 | 开发者 | 待开始 |

**交付物**：
- ✅ 测试报告
- ✅ 性能测试报告
- ✅ 安全测试报告
- ✅ Bug修复清单

### 第十阶段：部署与上线（1周）

**目标**：完成扣子云平台部署和上线

**任务列表**：

| 序号 | 任务 | 预计时间 | 负责人 | 状态 |
|------|------|----------|--------|------|
| 10.1 | 准备部署环境 | 0.5天 | 运维 | 待开始 |
| 10.2 | 配置生产环境变量 | 0.5天 | 运维 | 待开始 |
| 10.3 | 执行数据库迁移 | 0.5天 | 运维 | 待开始 |
| 10.4 | 部署到扣子云平台 | 0.5天 | 运维 | 待开始 |
| 10.5 | 配置域名和HTTPS | 0.5天 | 运维 | 待开始 |
| 10.6 | 执行冒烟测试 | 0.5天 | 测试 | 待开始 |
| 10.7 | 灰度发布 | 1天 | 运维 | 待开始 |
| 10.8 | 全量发布 | 0.5天 | 运维 | 待开始 |
| 10.9 | 上线后监控 | 持续 | 运维 | 待开始 |

**交付物**：
- ✅ 生产环境部署
- ✅ 域名配置
- ✅ 上线报告

---

## ⚠️ 风险评估

### 1. 技术风险

| 风险 | 可能性 | 影响 | 应对措施 |
|------|--------|------|----------|
| 扣子云平台WebSocket支持问题 | 中 | 高 | 提前验证WebSocket功能，准备备用方案（HTTP轮询） |
| PostgreSQL消息队列性能问题 | 中 | 中 | 压力测试验证，准备切换到Redis |
| LLM技能调用失败率高 | 低 | 中 | 实现重试机制和降级策略 |
| 第三方回调超时 | 高 | 中 | 实现3秒超时和自动重试 |

### 2. 开发风险

| 风险 | 可能性 | 影响 | 应对措施 |
|------|--------|------|----------|
| 开发进度延期 | 中 | 中 | 增加开发人员，优化任务分配 |
| 需求变更 | 中 | 中 | 锁定核心需求，次要需求延后 |
| 技术难点攻克困难 | 低 | 高 | 提前技术调研，寻求技术支持 |

### 3. 运营风险

| 风险 | 可能性 | 影响 | 应对措施 |
|------|--------|------|----------|
| 用户量增长过快导致系统崩溃 | 低 | 高 | 实现弹性伸缩，准备扩容方案 |
| 第三方平台接口不稳定 | 中 | 中 | 监控接口状态，实现降级策略 |
| 支付接口问题 | 低 | 中 | 多支付渠道备用 |

---

## 🧪 测试计划

### 1. 单元测试

**测试范围**：
- 所有后端API接口
- 所有前端组件
- 数据库操作
- 工具函数

**测试覆盖率目标**：80%+

### 2. 集成测试

**测试场景**：
- 用户注册 → 激活码购买 → 设备激活 → 消息发送
- 消息接收 → 第三方回调 → AI回复 → 消息发送
- 管理员操作（生成激活码、解绑设备、禁用用户）

### 3. 性能测试

**测试指标**：
- API响应时间 < 500ms（P95）
- 并发支持 1000 QPS
- WebSocket连接数 > 10000
- 数据库查询 < 100ms（P95）

**测试工具**：
- JMeter
- Artillery
- k6

### 4. 压力测试

**测试场景**：
- 1000并发用户同时激活
- 1000并发用户同时发送消息
- 10000并发WebSocket连接

### 5. 安全测试

**测试内容**：
- SQL注入测试
- XSS攻击测试
- CSRF攻击测试
- API越权测试
- 签名验证测试

**测试工具**：
- OWASP ZAP
- Burp Suite

---

## 🚀 部署计划

### 1. 环境准备

**生产环境配置**：
- 扣子云平台账号
- PostgreSQL数据库（主库）
- PostgreSQL数据库（消息队列）
- S3对象存储
- 阿里云短信服务
- 微信支付商户号
- LLM API密钥

### 2. 数据库迁移

```sql
-- 执行数据库初始化脚本
psql -U postgres -d workbot -f schema.sql

-- 创建数据库视图
psql -U postgres -d workbot -f views.sql

-- 配置定时任务
psql -U postgres -d workbot -f cron_jobs.sql
```

### 3. 部署步骤

```bash
# 1. 构建项目
pnpm run build

# 2. 部署到扣子云平台
coze build
coze start

# 3. 配置环境变量
# 在扣子云平台控制台配置

# 4. 配置域名和HTTPS
# 在扣子云平台控制台配置

# 5. 执行数据库迁移
# 在数据库服务器执行

# 6. 执行冒烟测试
curl https://your-domain.coze.site/health

# 7. 灰度发布
# 开放10%流量

# 8. 全量发布
# 开放100%流量
```

### 4. 监控配置

**监控指标**：
- 服务器CPU使用率
- 服务器内存使用率
- 服务器磁盘使用率
- 数据库连接数
- API响应时间
- WebSocket连接数
- 消息处理成功率
- AI调用成功率

**告警规则**：
- CPU使用率 > 80%
- 内存使用率 > 80%
- API响应时间 > 1s
- 消息处理失败率 > 1%
- WebSocket连接失败率 > 1%

---

## 📊 时间规划总览

| 阶段 | 任务 | 预计时间 | 开始日期 | 结束日期 |
|------|------|----------|----------|----------|
| 第一阶段 | 基础架构搭建 | 2周 | Week 1 | Week 2 |
| 第二阶段 | 用户管理系统 | 1周 | Week 3 | Week 3 |
| 第三阶段 | 激活码管理系统 | 1.5周 | Week 4 | Week 5 |
| 第四阶段 | 机器人管理系统 | 1.5周 | Week 6 | Week 7 |
| 第五阶段 | 消息处理系统 | 2周 | Week 8 | Week 9 |
| 第六阶段 | 第三方集成模块 | 1.5周 | Week 10 | Week 11 |
| 第七阶段 | WebSocket通讯模块 | 1周 | Week 12 | Week 12 |
| 第八阶段 | 系统监控模块 | 1周 | Week 13 | Week 13 |
| 第九阶段 | 测试与优化 | 1.5周 | Week 14 | Week 15 |
| 第十阶段 | 部署与上线 | 1周 | Week 16 | Week 16 |

**总计**：16周（约4个月）

---

## 🎯 关键里程碑

| 里程碑 | 日期 | 交付物 |
|--------|------|--------|
| M1 | Week 2 | 基础架构搭建完成 |
| M2 | Week 3 | 用户管理系统完成 |
| M3 | Week 5 | 激活码管理系统完成 |
| M4 | Week 7 | 机器人管理系统完成 |
| M5 | Week 9 | 消息处理系统完成 |
| M6 | Week 11 | 第三方集成模块完成 |
| M7 | Week 12 | WebSocket通讯模块完成 |
| M8 | Week 13 | 系统监控模块完成 |
| M9 | Week 15 | 测试与优化完成 |
| M10 | Week 16 | 系统上线 |

---

## 📝 上线后维护计划

### 1. 日常运维

**每日任务**：
- 检查系统日志
- 检查监控指标
- 检查告警信息
- 备份数据库

**每周任务**：
- 性能分析报告
- 用户反馈汇总
- Bug修复
- 功能优化

**每月任务**：
- 系统健康检查
- 安全漏洞扫描
- 数据库优化
- 容量评估

### 2. 版本迭代

**迭代周期**：2周

**迭代内容**：
- Bug修复
- 功能优化
- 新功能开发

**发布策略**：
- 灰度发布（10% → 50% → 100%）
- 回滚预案

### 3. 客户支持

**支持渠道**：
- 在线客服
- 工单系统
- 技术文档
- 视频教程

**响应时间**：
- 紧急问题：1小时内
- 一般问题：4小时内
- 功能建议：1周内

---

## 🔗 相关文档

- [WorkBot 最终需求文档 v2.0](./workbot_final_requirements_v2.md)
- [WorkBot 数据库设计文档](./workbot_database_design.md)
- [WorkBot API 接口文档](./workbot_api_reference.md)
- [WorkBot 第三方AI平台集成文档](./workbot_third_party_integration.md)
- [激活码管理逻辑详细文档](./activation_code_logic.md)

---

**文档创建日期**：2025-02-07  
**文档版本**：v1.0  
**最后更新**：2025-02-07
