# WorkBot ç¬¬ä¸‰æ–¹é›†æˆç³»ç»Ÿåˆ†æ

## æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£å…¨é¢åˆ†æ WorkBot ç³»ç»Ÿï¼Œä¸ºå®æ–½æ–°çš„ç¬¬ä¸‰æ–¹é›†æˆæ–¹æ¡ˆåšå¥½è¡”æ¥å‡†å¤‡ã€‚

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ†ææ—¥æœŸ**: 2026-02-09
**æ–¹æ¡ˆ**: APP ç›´æ¥å‘é€æ¶ˆæ¯åˆ°ç¬¬ä¸‰æ–¹å¹³å° + æ™ºèƒ½å›é€€æœºåˆ¶

---

## ä¸€ã€ç³»ç»Ÿæ¶æ„åˆ†æ

### 1.1 å½“å‰æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å®¢æˆ·ç«¯å±‚                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Admin Web  â”‚  â”‚   User Web   â”‚  â”‚ WorkTool App â”‚      â”‚
â”‚  â”‚  (ç®¡ç†åå°)   â”‚  â”‚  (ç”¨æˆ·å‰ç«¯)   â”‚  â”‚  (Android)   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æœåŠ¡ç«¯å±‚                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚           Next.js HTTP Server (5000)                â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚   API     â”‚  â”‚   Pages   â”‚  â”‚   WebSocket     â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  Routes   â”‚  â”‚  (Admin)  â”‚  â”‚   Server v3.0   â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ•°æ®å±‚                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ PostgreSQL   â”‚  â”‚   Redis      â”‚  â”‚   File       â”‚      â”‚
â”‚  â”‚ (ä¸»æ•°æ®åº“)    â”‚  â”‚  (ç¼“å­˜)      â”‚  â”‚  (æ—¥å¿—)      â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æŠ€æœ¯æ ˆ

| ç»„ä»¶ | æŠ€æœ¯ | ç‰ˆæœ¬ |
|------|------|------|
| å‰ç«¯æ¡†æ¶ | Next.js | 15.5.12 (App Router) |
| UI åº“ | React | 19 |
| è¯­è¨€ | TypeScript | 5 |
| æ ·å¼ | Tailwind CSS | 3.4 |
| ç»„ä»¶åº“ | shadcn/ui | - |
| æ•°æ®åº“ | PostgreSQL | 18 |
| ORM | Drizzle ORM | 0.45.1 |
| WebSocket | ws | - |
| è®¤è¯ | JWT | jsonwebtoken |
| åŠ å¯† | bcryptjs | - |
| éªŒè¯ | Zod | - |

---

## äºŒã€æ•°æ®åº“è¡¨ç»“æ„åˆ†æ

### 2.1 æ ¸å¿ƒè¡¨ç»“æ„

#### 2.1.1 ç”¨æˆ·è¡¨ (users)

```typescript
{
  id: serial,                    // ä¸»é”®
  nickname: varchar(100),        // æ˜µç§°
  avatar: text,                  // å¤´åƒ
  phone: varchar(20),            // æ‰‹æœºå·ï¼ˆå”¯ä¸€ï¼‰
  passwordHash: text,            // å¯†ç å“ˆå¸Œ
  role: varchar(20),             // è§’è‰²: admin, user
  status: varchar(20),           // çŠ¶æ€: active, disabled
  createdAt: timestamp,          // åˆ›å»ºæ—¶é—´
  updatedAt: timestamp,          // æ›´æ–°æ—¶é—´
  lastLoginAt: timestamp,        // æœ€åç™»å½•æ—¶é—´
}
```

**ç´¢å¼•**:
- `users_phone_idx` (phone)

---

#### 2.1.2 æ¿€æ´»ç è¡¨ (activation_codes)

```typescript
{
  id: serial,                    // ä¸»é”®
  code: varchar(8),              // 8ä½æ¿€æ´»ç ï¼ˆå”¯ä¸€ï¼‰
  status: varchar(20),           // çŠ¶æ€: unused, used, expired, disabled
  validityPeriod: integer,       // æœ‰æ•ˆæœŸï¼ˆå¤©æ•°ï¼‰
  boundUserId: integer,          // ç»‘å®šçš„ç”¨æˆ·ID
  price: decimal(10,2),          // ä»·æ ¼
  createdBy: integer,            // åˆ›å»ºäººID
  createdAt: timestamp,          // åˆ›å»ºæ—¶é—´
  expiresAt: timestamp,          // æ¿€æ´»ç è¿‡æœŸæ—¶é—´
  usedAt: timestamp,             // é¦–æ¬¡ä½¿ç”¨æ—¶é—´
  notes: text,                   // å¤‡æ³¨
}
```

**ç´¢å¼•**:
- `activation_codes_code_idx` (code)
- `activation_codes_status_idx` (status)

---

#### 2.1.3 æœºå™¨äººé…ç½®è¡¨ (robots)

```typescript
{
  id: serial,                    // ä¸»é”®
  robotId: varchar(255),         // æœºå™¨äººIDï¼ˆå”¯ä¸€ï¼‰
  robotUuid: varchar(255),       // æœºå™¨äººUUIDï¼ˆå”¯ä¸€ï¼‰
  userId: integer,               // ç”¨æˆ·ID
  name: varchar(100),            // æœºå™¨äººåç§°
  status: varchar(20),           // çŠ¶æ€: online, offline, deleted

  // AIå›å¤æ¨¡å¼
  aiMode: varchar(20),           // builtin, third_party
  aiProvider: varchar(50),       // doubao, deepseek, kimi, custom
  aiModel: varchar(100),         // æ¨¡å‹åç§°
  aiApiKey: text,                // APIå¯†é’¥
  aiTemperature: decimal(3,2),   // æ¸©åº¦å‚æ•°
  aiMaxTokens: integer,          // æœ€å¤§tokens
  aiContextLength: integer,      // ä¸Šä¸‹æ–‡é•¿åº¦
  aiScenario: varchar(50),       // åº”ç”¨åœºæ™¯

  // ç¬¬ä¸‰æ–¹å¹³å°é…ç½® â­ æ–°æ–¹æ¡ˆæ ¸å¿ƒå­—æ®µ
  thirdPartyCallbackUrl: text,          // æ¶ˆæ¯å›è°ƒåœ°å€
  thirdPartyResultCallbackUrl: text,    // ç»“æœå›è°ƒåœ°å€
  thirdPartySecretKey: text,            // å¯†é’¥

  // ç»Ÿè®¡ä¿¡æ¯
  totalMessages: integer,        // æ€»æ¶ˆæ¯æ•°
  aiCallsToday: integer,         // ä»Šæ—¥AIè°ƒç”¨æ¬¡æ•°
  lastResetAt: timestamp,        // æœ€åé‡ç½®æ—¶é—´
  lastActiveAt: timestamp,       // æœ€åæ´»è·ƒæ—¶é—´

  createdAt: timestamp,          // åˆ›å»ºæ—¶é—´
  updatedAt: timestamp,          // æ›´æ–°æ—¶é—´
  deletedAt: timestamp,          // åˆ é™¤æ—¶é—´
}
```

**ç´¢å¼•**:
- `robots_robot_id_idx` (robotId)
- `robots_user_id_idx` (userId)

**å…³é”®å­—æ®µè¯´æ˜**ï¼ˆæ–°æ–¹æ¡ˆï¼‰:
- `thirdPartyCallbackUrl`: ç¬¬ä¸‰æ–¹å¹³å°çš„æ¶ˆæ¯å›è°ƒåœ°å€
  - APP å‘é€æ¶ˆæ¯çš„ç›®æ ‡åœ°å€
  - æ ¼å¼ï¼š`https://api.dify.ai/callback`
  - APP ç”Ÿæˆå®Œæ•´å›è°ƒåœ°å€ï¼š`{url}/api/worktool/callback/{type}?robotId={robotId}`

- `thirdPartyResultCallbackUrl`: ç¬¬ä¸‰æ–¹å¹³å°çš„ç»“æœå›è°ƒåœ°å€
  - ç¬¬ä¸‰æ–¹å¹³å°å¤„ç†å®Œæ¶ˆæ¯åï¼Œè°ƒç”¨æ­¤åœ°å€å‘é€å›å¤
  - æ ¼å¼ï¼š`https://api.dify.ai/result`
  - æœåŠ¡å™¨é€šè¿‡ WebSocket æ¨é€ç»™ APP

- `thirdPartySecretKey`: ç¬¬ä¸‰æ–¹å¹³å°çš„å¯†é’¥
  - ç”¨äºç­¾åéªŒè¯ï¼ˆå¯é€‰ï¼‰
  - ä¿è¯å®‰å…¨æ€§

---

#### 2.1.4 æœºå™¨äººæˆå‘˜è¡¨ (robot_members)

```typescript
{
  id: serial,                    // ä¸»é”®
  robotId: integer,              // æœºå™¨äººID
  userId: integer,               // ç”¨æˆ·ID
  memberId: varchar(255),        // æˆå‘˜ID
  memberName: varchar(100),      // æˆå‘˜åç§°
  memberAvatar: varchar(500),    // æˆå‘˜å¤´åƒ
  status: varchar(20),           // çŠ¶æ€: active, inactive
  role: varchar(20),             // è§’è‰²: member, admin
  tags: text,                    // æ ‡ç­¾ï¼ˆJSONï¼‰
  customData: text,              // è‡ªå®šä¹‰æ•°æ®ï¼ˆJSONï¼‰
  createdAt: timestamp,          // åˆ›å»ºæ—¶é—´
  updatedAt: timestamp,          // æ›´æ–°æ—¶é—´
}
```

**ç´¢å¼•**:
- `robot_members_robot_id_idx` (robotId)
- `robot_members_user_id_idx` (userId)

---

#### 2.1.5 å¯¹è¯ä¼šè¯è¡¨ (conversations)

```typescript
{
  id: serial,                    // ä¸»é”®
  conversationId: varchar(255),  // ä¼šè¯IDï¼ˆå”¯ä¸€ï¼‰
  robotId: integer,              // æœºå™¨äººID
  memberId: integer,             // æˆå‘˜ID
  status: varchar(20),           // çŠ¶æ€: active, closed, archived
  summary: text,                 // å¯¹è¯æ‘˜è¦
  tags: text,                    // æ ‡ç­¾ï¼ˆJSONï¼‰
  messageCount: integer,         // æ¶ˆæ¯æ•°é‡
  lastMessageAt: timestamp,      // æœ€åæ¶ˆæ¯æ—¶é—´
  createdAt: timestamp,          // åˆ›å»ºæ—¶é—´
  updatedAt: timestamp,          // æ›´æ–°æ—¶é—´
  closedAt: timestamp,           // å…³é—­æ—¶é—´
}
```

**ç´¢å¼•**:
- `conversations_conversation_id_idx` (conversationId)
- `conversations_robot_id_idx` (robotId)
- `conversations_member_id_idx` (memberId)

---

#### 2.1.6 æ¶ˆæ¯è®°å½•è¡¨ (messages)

```typescript
{
  id: serial,                    // ä¸»é”®
  conversationId: integer,       // ä¼šè¯ID
  robotId: integer,              // æœºå™¨äººID
  memberId: integer,             // æˆå‘˜ID
  messageType: varchar(20),      // æ¶ˆæ¯ç±»å‹: text, image, voice, video, file, link, system
  direction: varchar(20),        // æ–¹å‘: inbound, outbound
  content: text,                 // æ¶ˆæ¯å†…å®¹
  mediaUrl: text,                // åª’ä½“æ–‡ä»¶URL
  aiGenerated: boolean,          // æ˜¯å¦AIç”Ÿæˆ
  aiModel: varchar(100),         // AIæ¨¡å‹
  aiTokensUsed: integer,         // AIä½¿ç”¨çš„tokens
  aiCost: decimal(10,4),         // AIæˆæœ¬
  metadata: text,                // å…ƒæ•°æ®ï¼ˆJSONï¼‰
  createdAt: timestamp,          // åˆ›å»ºæ—¶é—´
}
```

**ç´¢å¼•**:
- `messages_conversation_id_idx` (conversationId)
- `messages_robot_id_idx` (robotId)
- `messages_created_at_idx` (createdAt)

---

#### 2.1.7 AIè°ƒç”¨æ—¥å¿—è¡¨ (ai_logs)

```typescript
{
  id: serial,                    // ä¸»é”®
  robotId: integer,              // æœºå™¨äººID
  conversationId: integer,       // ä¼šè¯ID
  messageId: integer,            // æ¶ˆæ¯ID
  provider: varchar(50),         // æä¾›å•†: doubao, deepseek, kimi, custom
  model: varchar(100),           // æ¨¡å‹åç§°
  requestText: text,             // è¯·æ±‚æ–‡æœ¬
  responseText: text,            // å“åº”æ–‡æœ¬
  tokensUsed: integer,           // ä½¿ç”¨çš„tokens
  cost: decimal(10,4),           // æˆæœ¬
  latency: integer,              // å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰
  status: varchar(20),           // çŠ¶æ€: success, failed
  errorMessage: text,            // é”™è¯¯æ¶ˆæ¯
  createdAt: timestamp,          // åˆ›å»ºæ—¶é—´
}
```

**ç´¢å¼•**:
- `ai_logs_robot_id_idx` (robotId)
- `ai_logs_conversation_id_idx` (conversationId)
- `ai_logs_created_at_idx` (createdAt)

---

#### 2.1.8 æ—¥å¿—è¿œç¨‹è°ƒåº¦è¡¨ (logs)

```typescript
{
  id: varchar(64),               // ä¸»é”®
  robotId: varchar(64),          // æœºå™¨äººID
  timestamp: bigint,             // Unixæ¯«ç§’æ—¶é—´æˆ³
  level: integer,                // æ—¥å¿—çº§åˆ«: 0-5
  tag: varchar(128),             // æ—¥å¿—æ ‡ç­¾
  message: text,                 // æ¶ˆæ¯å†…å®¹
  extra: text,                   // æ‰©å±•ä¿¡æ¯ï¼ˆJSONï¼‰
  stackTrace: text,              // å †æ ˆè·Ÿè¸ª
  syncStatus: varchar(20),       // åŒæ­¥çŠ¶æ€: pending, syncing, success, failed, ignored
  syncTime: bigint,              // åŒæ­¥æ—¶é—´ï¼ˆUnixç§’ï¼‰
  deviceId: varchar(128),        // è®¾å¤‡ID
  createdAt: timestamp,          // åˆ›å»ºæ—¶é—´
}
```

**ç´¢å¼•**:
- `logs_robot_id_idx` (robotId)
- `logs_timestamp_idx` (timestamp)
- `logs_level_idx` (level)
- `logs_tag_idx` (tag)
- `logs_sync_status_idx` (syncStatus)

---

#### 2.1.9 æ—¥å¿—é…ç½®è¡¨ (log_configs)

```typescript
{
  robotId: varchar(64),          // æœºå™¨äººIDï¼ˆä¸»é”®ï¼‰
  logLevel: integer,             // æ—¥å¿—çº§åˆ«: 0-5
  uploadEnabled: boolean,        // æ˜¯å¦å¯ç”¨ä¸Šä¼ 
  uploadInterval: integer,       // ä¸Šä¼ é—´éš”ï¼ˆæ¯«ç§’ï¼‰
  uploadOnWifiOnly: boolean,     // ä»…WiFiä¸Šä¼ 
  maxLogEntries: integer,        // æœ€å¤§æ—¥å¿—æ¡æ•°
  retentionDays: integer,        // ä¿ç•™å¤©æ•°
  tags: text,                    // æ ‡ç­¾é…ç½®ï¼ˆJSONï¼‰
  updatedAt: timestamp,          // æ›´æ–°æ—¶é—´
}
```

---

### 2.2 éœ€è¦æ–°å¢çš„è¡¨

#### 2.2.1 è®¾å¤‡æ¿€æ´»è¡¨ (device_activations)

**è¯´æ˜**: æ­¤è¡¨ç”¨äºç®¡ç† APP æ¿€æ´»å’Œè®¾å¤‡ç»‘å®šï¼Œæ˜¯æ–°æ–¹æ¡ˆçš„æ ¸å¿ƒè¡¨ã€‚

```typescript
{
  id: serial,                    // ä¸»é”®
  robotId: varchar(255),         // æœºå™¨äººIDï¼ˆå”¯ä¸€ï¼‰â­
  robotUuid: varchar(255),       // æœºå™¨äººUUIDï¼ˆå”¯ä¸€ï¼‰
  deviceId: varchar(255),        // è®¾å¤‡ID
  userId: integer,               // ç”¨æˆ·ID
  activationCode: varchar(8),    // æ¿€æ´»ç 
  status: varchar(20),           // çŠ¶æ€: active, inactive, expired
  activatedAt: timestamp,        // æ¿€æ´»æ—¶é—´
  expiresAt: timestamp,          // è¿‡æœŸæ—¶é—´
  lastSeenAt: timestamp,         // æœ€ååœ¨çº¿æ—¶é—´
  deviceInfo: text,              // è®¾å¤‡ä¿¡æ¯ï¼ˆJSONï¼‰

  // é…ç½®åŒæ­¥ç›¸å…³ â­ æ–°å¢
  configVersion: integer,        // é…ç½®ç‰ˆæœ¬å·
  configSyncedAt: timestamp,     // é…ç½®åŒæ­¥æ—¶é—´
  configSynced: boolean,         // æ˜¯å¦å·²åŒæ­¥
  configError: text,             // é…ç½®é”™è¯¯ä¿¡æ¯

  createdAt: timestamp,          // åˆ›å»ºæ—¶é—´
  updatedAt: timestamp,          // æ›´æ–°æ—¶é—´
}
```

**ç´¢å¼•**:
- `device_activations_robot_id_idx` (robotId)
- `device_activations_device_id_idx` (deviceId)
- `device_activations_user_id_idx` (userId)

**å…³é”®å­—æ®µè¯´æ˜**:
- `robotId`: APP ä½¿ç”¨çš„æœºå™¨äººæ ‡è¯†ç¬¦ï¼ˆ20ä½ä¸­è‹±æ–‡æ•°å­—æ··åˆï¼‰
- `configVersion`: é…ç½®ç‰ˆæœ¬å·ï¼Œç”¨äºé˜²æ­¢é…ç½®å†²çª
- `configSynced`: é…ç½®æ˜¯å¦å·²åŒæ­¥åˆ° APP
- `configError`: é…ç½®åŒæ­¥å¤±è´¥æ—¶çš„é”™è¯¯ä¿¡æ¯

---

#### 2.2.2 é…ç½®åŒæ­¥æ—¥å¿—è¡¨ (config_sync_logs)

**è¯´æ˜**: è®°å½•é…ç½®æ¨é€å’ŒåŒæ­¥çš„è¯¦ç»†æ—¥å¿—ã€‚

```typescript
{
  id: serial,                    // ä¸»é”®
  robotId: varchar(255),         // æœºå™¨äººID
  configVersion: varchar(50),    // é…ç½®ç‰ˆæœ¬å·
  configData: jsonb,             // é…ç½®æ•°æ®ï¼ˆJSONBï¼‰
  syncStatus: varchar(20),       // åŒæ­¥çŠ¶æ€: pending, synced, failed
  syncedAt: timestamp,           // åŒæ­¥æ—¶é—´
  errorMessage: text,            // é”™è¯¯æ¶ˆæ¯
  createdAt: timestamp,          // åˆ›å»ºæ—¶é—´
}
```

**ç´¢å¼•**:
- `config_sync_logs_robot_id_idx` (robotId)
- `config_sync_logs_status_idx` (syncStatus)
- `config_sync_logs_version_idx` (configVersion)

---

#### 2.2.3 æ¶ˆæ¯å‘é€å¤±è´¥æ—¥å¿—è¡¨ (message_fail_logs)

**è¯´æ˜**: è®°å½• APP å‘é€æ¶ˆæ¯åˆ°ç¬¬ä¸‰æ–¹å¹³å°å¤±è´¥çš„æ—¥å¿—ã€‚

```typescript
{
  id: serial,                    // ä¸»é”®
  robotId: varchar(255),         // æœºå™¨äººID
  messageId: varchar(255),       // æ¶ˆæ¯ID
  thirdPartyUrl: text,           // ç¬¬ä¸‰æ–¹URL
  errorMessage: text,            // é”™è¯¯æ¶ˆæ¯
  errorType: varchar(50),        // é”™è¯¯ç±»å‹: timeout, network, server, client
  retryCount: integer,           // é‡è¯•æ¬¡æ•°
  failedAt: timestamp,           // å¤±è´¥æ—¶é—´
  createdAt: timestamp,          // åˆ›å»ºæ—¶é—´
}
```

**ç´¢å¼•**:
- `message_fail_logs_robot_id_idx` (robotId)
- `message_fail_logs_message_id_idx` (messageId)
- `message_fail_logs_error_type_idx` (errorType)
- `message_fail_logs_created_at_idx` (createdAt)

---

#### 2.2.4 ä¼šè¯è¡¨ (sessions)

**è¯´æ˜**: ç”¨äºç®¡ç†ä¼šè¯çŠ¶æ€ï¼Œæ›¿ä»£ `conversations` è¡¨ï¼ˆç®€åŒ–ç‰ˆï¼‰ã€‚

```typescript
{
  id: serial,                    // ä¸»é”®
  sessionId: varchar(255),       // ä¼šè¯IDï¼ˆå”¯ä¸€ï¼‰
  robotId: varchar(255),         // æœºå™¨äººID
  userId: varchar(255),          // ç”¨æˆ·ID
  status: varchar(20),           // çŠ¶æ€: active, closed, archived
  messageCount: integer,         // æ¶ˆæ¯æ•°é‡
  lastMessageAt: timestamp,      // æœ€åæ¶ˆæ¯æ—¶é—´
  createdAt: timestamp,          // åˆ›å»ºæ—¶é—´
  updatedAt: timestamp,          // æ›´æ–°æ—¶é—´
}
```

**ç´¢å¼•**:
- `sessions_session_id_idx` (sessionId)
- `sessions_robot_id_idx` (robotId)
- `sessions_user_id_idx` (userId)

---

## ä¸‰ã€API æ¥å£åˆ†æ

### 3.1 ç°æœ‰æ¥å£åˆ—è¡¨

| æ¥å£è·¯å¾„ | æ–¹æ³• | è¯´æ˜ | çŠ¶æ€ |
|---------|------|------|------|
| `/api/auth/login` | POST | ç”¨æˆ·ç™»å½• | âœ… å·²å®ç° |
| `/api/auth/refresh-token` | POST | åˆ·æ–° Token | âœ… å·²å®ç° |
| `/api/activation-codes` | GET/POST | æ¿€æ´»ç ç®¡ç† | âœ… å·²å®ç° |
| `/api/robots` | GET/POST | æœºå™¨äººç®¡ç† | âœ… å·²å®ç° |
| `/api/robot-ids/activate` | POST | è®¾å¤‡æ¿€æ´» | âœ… å·²å®ç° |
| `/api/worktool/callback` | POST | WorkTool å›è°ƒ | âœ… å·²å®ç° |
| `/api/worktool/sendMessage` | POST | å‘é€ WorkTool æ¶ˆæ¯ | âœ… å·²å®ç° |
| `/api/callback` | GET/POST | ç¬¬ä¸‰æ–¹å›è°ƒ | âœ… å·²å®ç° |
| `/api/messages/send` | POST | å‘é€æ¶ˆæ¯ | âœ… å·²å®ç° |
| `/api/messages/list` | GET | æ¶ˆæ¯åˆ—è¡¨ | âœ… å·²å®ç° |
| `/api/knowledge-bases` | GET/POST | çŸ¥è¯†åº“ç®¡ç† | âœ… å·²å®ç° |

### 3.2 éœ€è¦æ–°å¢çš„æ¥å£

| æ¥å£è·¯å¾„ | æ–¹æ³• | è¯´æ˜ | ä¼˜å…ˆçº§ |
|---------|------|------|--------|
| `/api/device/config` | GET | è®¾å¤‡é…ç½®æŸ¥è¯¢ï¼ˆå…œåº•æ–¹æ¡ˆï¼‰ | ğŸ”´ é«˜ |
| `/api/third-party/callback/{type}` | POST | ç¬¬ä¸‰æ–¹å›è°ƒç»Ÿä¸€æ¥å£ | ğŸ”´ é«˜ |
| `/api/third-party/fallback/message` | POST | æ¶ˆæ¯å›é€€æ¥å£ | ğŸ”´ é«˜ |
| `/api/robots/[robotId]/config` | GET/PUT | æœºå™¨äººé…ç½®ç®¡ç† | ğŸŸ¡ ä¸­ |
| `/api/robots/[robotId]/config-status` | GET | é…ç½®åŒæ­¥çŠ¶æ€æŸ¥è¯¢ | ğŸŸ¡ ä¸­ |
| `/api/robots/[robotId]/message-logs` | GET | æ¶ˆæ¯æ—¥å¿—æŸ¥è¯¢ | ğŸŸ¢ ä½ |
| `/api/robots/[robotId]/fail-logs` | GET | å¤±è´¥æ—¥å¿—æŸ¥è¯¢ | ğŸŸ¢ ä½ |

### 3.3 éœ€è¦ä¿®æ”¹çš„æ¥å£

| æ¥å£è·¯å¾„ | ä¿®æ”¹å†…å®¹ | åŸå›  |
|---------|---------|------|
| `/api/worktool/callback` | ä¿®æ”¹æ¶ˆæ¯å¤„ç†é€»è¾‘ | å¢åŠ é…ç½®åŒæ­¥æ—¥å¿—è®°å½• |
| `/api/robots` | å¢åŠ ç¬¬ä¸‰æ–¹é…ç½®å­—æ®µ | æ”¯æŒé…ç½®ç®¡ç† |

---

## å››ã€WebSocket åè®®åˆ†æ

### 4.1 ç°æœ‰æ¶ˆæ¯ç±»å‹

| ç±»å‹ | æ–¹å‘ | è¯´æ˜ | çŠ¶æ€ |
|------|------|------|------|
| `authenticate` | APP â†’ æœåŠ¡å™¨ | è®¤è¯è¯·æ±‚ | âœ… å·²å®ç° |
| `authenticated` | æœåŠ¡å™¨ â†’ APP | è®¤è¯å“åº” | âœ… å·²å®ç° |
| `heartbeat` | åŒå‘ | å¿ƒè·³æ¶ˆæ¯ | âœ… å·²å®ç° |
| `heartbeat_ack` | æœåŠ¡å™¨ â†’ APP | å¿ƒè·³ç¡®è®¤ | âœ… å·²å®ç° |
| `heartbeat_warning` | æœåŠ¡å™¨ â†’ APP | å¿ƒè·³è­¦å‘Š | âœ… å·²å®ç° |
| `command_push` | æœåŠ¡å™¨ â†’ APP | æŒ‡ä»¤æ¨é€ | âœ… å·²å®ç° |
| `result` | APP â†’ æœåŠ¡å™¨ | ç»“æœä¸ŠæŠ¥ | âœ… å·²å®ç° |
| `config_push` | æœåŠ¡å™¨ â†’ APP | é…ç½®æ¨é€ | âœ… å·²å®ç° |
| `status_query` | APP â†’ æœåŠ¡å™¨ | çŠ¶æ€æŸ¥è¯¢ | âœ… å·²å®ç° |
| `status_response` | æœåŠ¡å™¨ â†’ APP | çŠ¶æ€å“åº” | âœ… å·²å®ç° |
| `error` | æœåŠ¡å™¨ â†’ APP | é”™è¯¯æ¶ˆæ¯ | âœ… å·²å®ç° |

### 4.2 éœ€è¦æ–°å¢çš„æ¶ˆæ¯ç±»å‹

| ç±»å‹ | æ–¹å‘ | è¯´æ˜ | ä¼˜å…ˆçº§ |
|------|------|------|--------|
| `config_ack` | APP â†’ æœåŠ¡å™¨ | é…ç½®ç¡®è®¤ | ğŸ”´ é«˜ |
| `config_nack` | APP â†’ æœåŠ¡å™¨ | é…ç½®æ‹’ç» | ğŸ”´ é«˜ |
| `callback` | æœåŠ¡å™¨ â†’ APP | æ¶ˆæ¯å›è°ƒ | ğŸ”´ é«˜ |
| `message_log` | APP â†’ æœåŠ¡å™¨ | æ¶ˆæ¯æ—¥å¿—ä¸ŠæŠ¥ | ğŸŸ¡ ä¸­ |

### 4.3 æ¶ˆæ¯ç±»å‹å®šä¹‰

#### 4.3.1 é…ç½®æ¨é€æ¶ˆæ¯ (config_push)

```typescript
{
  type: "config_push",
  data: {
    robotId: string,              // æœºå™¨äººID
    worktoolApiUrl: string,       // ç¬¬ä¸‰æ–¹APIåœ°å€
    resultCallbackUrl?: string,   // ç»“æœå›è°ƒåœ°å€
    secretKey?: string,           // å¯†é’¥
    updatedAt: number,            // æ›´æ–°æ—¶é—´ï¼ˆUnixæ¯«ç§’ï¼‰
    version: string,              // é…ç½®ç‰ˆæœ¬å·
    fallbackMode?: boolean        // æ˜¯å¦å›é€€æ¨¡å¼
  },
  timestamp: number
}
```

#### 4.3.2 é…ç½®ç¡®è®¤æ¶ˆæ¯ (config_ack)

```typescript
{
  type: "config_ack",
  data: {
    robotId: string,              // æœºå™¨äººID
    configVersion: string,        // é…ç½®ç‰ˆæœ¬å·
    ackTime: string               // ç¡®è®¤æ—¶é—´ï¼ˆISO 8601ï¼‰
  },
  timestamp: number
}
```

#### 4.3.3 é…ç½®æ‹’ç»æ¶ˆæ¯ (config_nack)

```typescript
{
  type: "config_nack",
  data: {
    robotId: string,              // æœºå™¨äººID
    configVersion: string,        // é…ç½®ç‰ˆæœ¬å·
    error: string,                // é”™è¯¯ä¿¡æ¯
    nackTime: string              // æ‹’ç»æ—¶é—´ï¼ˆISO 8601ï¼‰
  },
  timestamp: number
}
```

#### 4.3.4 æ¶ˆæ¯å›è°ƒæ¶ˆæ¯ (callback)

```typescript
{
  type: "callback",
  data: {
    event: "message" | "system",  // äº‹ä»¶ç±»å‹
    messageId?: string,           // æ¶ˆæ¯ID
    robotId: string,              // æœºå™¨äººID
    senderId?: string,            // å‘é€è€…ID
    senderName?: string,          // å‘é€è€…åç§°
    messageType?: string,         // æ¶ˆæ¯ç±»å‹
    content?: string,             // æ¶ˆæ¯å†…å®¹
    chatType?: string,            // èŠå¤©ç±»å‹
    extraData?: any,              // é¢å¤–æ•°æ®
    timestamp: string             // æ—¶é—´æˆ³ï¼ˆISO 8601ï¼‰
  },
  timestamp: number
}
```

#### 4.3.5 æ¶ˆæ¯æ—¥å¿—ä¸ŠæŠ¥æ¶ˆæ¯ (message_log)

```typescript
{
  type: "message_log",
  data: {
    messageId: string,            // æ¶ˆæ¯ID
    robotId: string,              // æœºå™¨äººID
    thirdPartyUrl: string,        // ç¬¬ä¸‰æ–¹URL
    status: "success" | "failed", // çŠ¶æ€
    error?: string,               // é”™è¯¯ä¿¡æ¯
    reportedAt: string            // ä¸ŠæŠ¥æ—¶é—´ï¼ˆISO 8601ï¼‰
  },
  timestamp: number
}
```

---

## äº”ã€ä»£ç ç»“æ„åˆ†æ

### 5.1 é¡¹ç›®ç›®å½•ç»“æ„

```
.
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/                          # Next.js App Router
â”‚   â”‚   â”œâ”€â”€ api/                      # API è·¯ç”±
â”‚   â”‚   â”‚   â”œâ”€â”€ auth/                 # è®¤è¯ç›¸å…³
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ login/            # ç™»å½•
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ refresh-token/    # Tokenåˆ·æ–°
â”‚   â”‚   â”‚   â”œâ”€â”€ activation-codes/     # æ¿€æ´»ç ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ robots/               # æœºå™¨äººç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ robot-ids/            # æœºå™¨äººIDç®¡ç†
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ activate/         # è®¾å¤‡æ¿€æ´» â­
â”‚   â”‚   â”‚   â”œâ”€â”€ worktool/             # WorkTool ç›¸å…³
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ callback/         # WorkTool å›è°ƒ â­
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ sendMessage/      # å‘é€æ¶ˆæ¯
â”‚   â”‚   â”‚   â”œâ”€â”€ third-party/          # ç¬¬ä¸‰æ–¹ç›¸å…³ ğŸ”´ æ–°å¢
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ callback/         # ç¬¬ä¸‰æ–¹å›è°ƒ
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ fallback/         # å›é€€æ¥å£
â”‚   â”‚   â”‚   â”œâ”€â”€ device/               # è®¾å¤‡ç›¸å…³ ğŸ”´ æ–°å¢
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ config/           # é…ç½®æŸ¥è¯¢
â”‚   â”‚   â”‚   â””â”€â”€ messages/             # æ¶ˆæ¯ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ robots/                   # æœºå™¨äººé¡µé¢
â”‚   â”‚   â””â”€â”€ dashboard/                # ä»ªè¡¨ç›˜
â”‚   â”œâ”€â”€ components/                   # React ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ ui/                       # shadcn/ui ç»„ä»¶
â”‚   â”‚   â””â”€â”€ layout/                   # å¸ƒå±€ç»„ä»¶
â”‚   â”œâ”€â”€ lib/                          # å·¥å…·åº“
â”‚   â”‚   â”œâ”€â”€ db.ts                     # æ•°æ®åº“è¿æ¥
â”‚   â”‚   â”œâ”€â”€ auth.ts                   # è®¤è¯å·¥å…·
â”‚   â”‚   â”œâ”€â”€ jwt.ts                    # JWT å·¥å…·
â”‚   â”‚   â””â”€â”€ api-client.ts             # API å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ server/                       # æœåŠ¡ç«¯ä»£ç 
â”‚   â”‚   â”œâ”€â”€ websocket/                # WebSocket ç›¸å…³
â”‚   â”‚   â”‚   â”œâ”€â”€ types.ts              # ç±»å‹å®šä¹‰ â­
â”‚   â”‚   â”‚   â”œâ”€â”€ message-handler.ts    # æ¶ˆæ¯å¤„ç† â­
â”‚   â”‚   â”‚   â”œâ”€â”€ connection-manager.ts # è¿æ¥ç®¡ç†
â”‚   â”‚   â”‚   â””â”€â”€ websocket-server-v3.ts # WebSocket æœåŠ¡å™¨
â”‚   â”‚   â””â”€â”€ middleware/               # ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ types/                        # ç±»å‹å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ worktool.ts               # WorkTool ç±»å‹ â­
â”‚   â”‚   â””â”€â”€ message.ts                # æ¶ˆæ¯ç±»å‹
â”‚   â”œâ”€â”€ db/                           # æ•°æ®åº“
â”‚   â”‚   â””â”€â”€ schema.ts                 # æ•°æ®åº“æ¨¡å¼ï¼ˆç®€åŒ–ç‰ˆï¼‰
â”‚   â””â”€â”€ storage/                      # å­˜å‚¨
â”‚       â””â”€â”€ database/
â”‚           â””â”€â”€ shared/
â”‚               â””â”€â”€ schema.ts         # æ•°æ®åº“æ¨¡å¼ï¼ˆå®Œæ•´ç‰ˆï¼‰â­
â”œâ”€â”€ docs/                             # æ–‡æ¡£
â”‚   â”œâ”€â”€ WORKTOOL_WEBSOCKET_CLIENT_DEVELOPMENT_GUIDE.md
â”‚   â””â”€â”€ THIRD_PARTY_INTEGRATION_SYSTEM_ANALYSIS.md â­ æœ¬æ–‡æ¡£
â””â”€â”€ .coze                             # Coze CLI é…ç½®
```

### 5.2 å…³é”®æ–‡ä»¶æ¸…å•

#### 5.2.1 éœ€è¦æ–°å¢çš„æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ | ä¼˜å…ˆçº§ |
|---------|------|--------|
| `src/app/api/device/config/route.ts` | è®¾å¤‡é…ç½®æŸ¥è¯¢æ¥å£ | ğŸ”´ é«˜ |
| `src/app/api/third-party/callback/[type]/route.ts` | ç¬¬ä¸‰æ–¹å›è°ƒç»Ÿä¸€æ¥å£ | ğŸ”´ é«˜ |
| `src/app/api/third-party/fallback/message/route.ts` | æ¶ˆæ¯å›é€€æ¥å£ | ğŸ”´ é«˜ |
| `src/app/api/robots/[robotId]/config/route.ts` | æœºå™¨äººé…ç½®ç®¡ç† | ğŸŸ¡ ä¸­ |
| `src/app/api/robots/[robotId]/config-status/route.ts` | é…ç½®åŒæ­¥çŠ¶æ€æŸ¥è¯¢ | ğŸŸ¡ ä¸­ |
| `src/app/api/robots/[robotId]/message-logs/route.ts` | æ¶ˆæ¯æ—¥å¿—æŸ¥è¯¢ | ğŸŸ¢ ä½ |
| `src/app/api/robots/[robotId]/fail-logs/route.ts` | å¤±è´¥æ—¥å¿—æŸ¥è¯¢ | ğŸŸ¢ ä½ |
| `src/app/api/worktool/message-log/route.ts` | æ¶ˆæ¯æ—¥å¿—ä¸ŠæŠ¥ | ğŸŸ¡ ä¸­ |
| `src/middleware/api-auth.ts` | API è®¤è¯ä¸­é—´ä»¶ | ğŸŸ¡ ä¸­ |

#### 5.2.2 éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | ä¿®æ”¹å†…å®¹ | åŸå›  |
|---------|---------|------|
| `src/server/websocket/types.ts` | æ–°å¢æ¶ˆæ¯ç±»å‹ | æ”¯æŒé…ç½®åŒæ­¥ |
| `src/server/websocket/message-handler.ts` | æ–°å¢æ¶ˆæ¯å¤„ç†é€»è¾‘ | å¤„ç†é…ç½®ç¡®è®¤/æ‹’ç» |
| `src/server/websocket-server-v3.ts` | æ–°å¢é…ç½®æ¨é€è§¦å‘æ—¶æœº | è¿æ¥æ—¶æ¨é€é…ç½® |
| `src/app/api/worktool/callback/route.ts` | ä¿®æ”¹æ¶ˆæ¯å¤„ç†é€»è¾‘ | å¢åŠ æ—¥å¿—è®°å½• |
| `src/storage/database/shared/schema.ts` | æ–°å¢æ•°æ®åº“è¡¨ | æ”¯æŒæ–°åŠŸèƒ½ |

---

## å…­ã€å…¼å®¹æ€§åˆ†æ

### 6.1 æ–°æ—§åè®®å…¼å®¹æ€§

#### 6.1.1 WebSocket åè®®å…¼å®¹æ€§

**ç°æœ‰åè®®**ï¼ˆv3.0ï¼‰:
- æ¶ˆæ¯ç±»å‹ï¼š`authenticate`, `heartbeat`, `command_push`, `result`, `config_push` ç­‰
- é…ç½®æ¨é€æ ¼å¼ï¼šä½¿ç”¨ `configType` å­—æ®µåŒºåˆ†é…ç½®ç±»å‹

**æ–°åè®®**ï¼ˆæ‰©å±•ï¼‰:
- æ–°å¢æ¶ˆæ¯ç±»å‹ï¼š`config_ack`, `config_nack`, `callback`, `message_log`
- é…ç½®æ¨é€æ ¼å¼ï¼šä½¿ç”¨ `worktoolApiUrl` å­—æ®µå­˜å‚¨ç¬¬ä¸‰æ–¹APIåœ°å€

**å…¼å®¹æ€§è¯„ä¼°**: âœ… **å‘åå…¼å®¹**
- æ–°å¢çš„æ¶ˆæ¯ç±»å‹ä¸å½±å“ç°æœ‰æ¶ˆæ¯å¤„ç†
- APP å¯ä»¥æ ¹æ®æ”¶åˆ°çš„æ¶ˆæ¯ç±»å‹é€‰æ‹©æ˜¯å¦å¤„ç†
- æ—§ç‰ˆæœ¬ APP å¿½ç•¥æ–°æ¶ˆæ¯ç±»å‹ï¼Œä¸ä¼šå´©æºƒ

#### 6.1.2 API æ¥å£å…¼å®¹æ€§

**ç°æœ‰æ¥å£**:
- `/api/worktool/callback` - WorkTool å›è°ƒ
- `/api/robot-ids/activate` - è®¾å¤‡æ¿€æ´»

**æ–°å¢æ¥å£**:
- `/api/device/config` - è®¾å¤‡é…ç½®æŸ¥è¯¢
- `/api/third-party/callback/{type}` - ç¬¬ä¸‰æ–¹å›è°ƒ
- `/api/third-party/fallback/message` - æ¶ˆæ¯å›é€€

**å…¼å®¹æ€§è¯„ä¼°**: âœ… **å®Œå…¨å…¼å®¹**
- æ–°æ¥å£æ˜¯ç‹¬ç«‹çš„ï¼Œä¸å½±å“ç°æœ‰æ¥å£
- ç°æœ‰æ¥å£ä¿æŒä¸å˜
- APP å¯ä»¥æ ¹æ®ç‰ˆæœ¬é€‰æ‹©ä½¿ç”¨å“ªäº›æ¥å£

### 6.2 æ•°æ®åº“å…¼å®¹æ€§

#### 6.2.1 è¡¨ç»“æ„å˜æ›´

**ç°æœ‰è¡¨**ï¼ˆéœ€è¦ä¿®æ”¹ï¼‰:
- `robots` è¡¨ï¼šå·²æœ‰ `thirdPartyCallbackUrl`, `thirdPartyResultCallbackUrl`, `thirdPartySecretKey` å­—æ®µ âœ…

**æ–°å¢è¡¨**:
- `device_activations` - è®¾å¤‡æ¿€æ´»è¡¨
- `config_sync_logs` - é…ç½®åŒæ­¥æ—¥å¿—è¡¨
- `message_fail_logs` - æ¶ˆæ¯å‘é€å¤±è´¥æ—¥å¿—è¡¨
- `sessions` - ä¼šè¯è¡¨

**å…¼å®¹æ€§è¯„ä¼°**: âœ… **å®Œå…¨å…¼å®¹**
- æ–°å¢è¡¨ä¸å½±å“ç°æœ‰è¡¨
- ç°æœ‰è¡¨ç»“æ„ä¸å˜
- æ•°æ®è¿ç§»é£é™©ä½

### 6.3 ä¸šåŠ¡é€»è¾‘å…¼å®¹æ€§

#### 6.3.1 æ¿€æ´»æµç¨‹

**ç°æœ‰æµç¨‹**:
```
APP â†’ æ¿€æ´»æ¥å£ â†’ ç”Ÿæˆ robotId â†’ è¿”å› Token
```

**æ–°æµç¨‹**:
```
APP â†’ æ¿€æ´»æ¥å£ â†’ ç”Ÿæˆ robotId â†’ ä¿å­˜åˆ° device_activations â†’ æ¨é€é…ç½® â†’ è¿”å› Token
```

**å…¼å®¹æ€§è¯„ä¼°**: âœ… **å…¼å®¹**
- æ¿€æ´»æ¥å£ä¿æŒä¸å˜
- æ–°å¢æ­¥éª¤å¯¹ APP é€æ˜
- APP æ— éœ€ä¿®æ”¹æ¿€æ´»é€»è¾‘

#### 6.3.2 æ¶ˆæ¯å‘é€æµç¨‹

**ç°æœ‰æµç¨‹**:
```
APP â†’ å‘é€åˆ°ç¬¬ä¸‰æ–¹å¹³å° â†’ ç¬¬ä¸‰æ–¹å¹³å° â†’ WorkBot æœåŠ¡å™¨ â†’ WebSocket æ¨é€ç»™ APP
```

**æ–°æµç¨‹**:
```
APP â†’ å‘é€åˆ°ç¬¬ä¸‰æ–¹å¹³å° â†’ ç¬¬ä¸‰æ–¹å¹³å° â†’ WorkBot æœåŠ¡å™¨ â†’ WebSocket æ¨é€ç»™ APP
      â†“
  å¤±è´¥æ—¶å›é€€åˆ°ä¸»æœåŠ¡å™¨
```

**å…¼å®¹æ€§è¯„ä¼°**: âœ… **å…¼å®¹**
- æ­£å¸¸æµç¨‹ä¸å˜
- æ–°å¢å›é€€é€»è¾‘ï¼ŒAPP æ— éœ€ä¿®æ”¹
- å›é€€é€»è¾‘å¯¹ APP é€æ˜

---

## ä¸ƒã€å®æ–½è®¡åˆ’

### 7.1 å®æ–½é˜¶æ®µåˆ’åˆ†

#### é˜¶æ®µä¸€ï¼šæ•°æ®åº“å‡†å¤‡ï¼ˆ1å¤©ï¼‰

**ä»»åŠ¡æ¸…å•**:
1. âœ… åˆ›å»º `device_activations` è¡¨
2. âœ… åˆ›å»º `config_sync_logs` è¡¨
3. âœ… åˆ›å»º `message_fail_logs` è¡¨
4. âœ… åˆ›å»º `sessions` è¡¨
5. âœ… æ·»åŠ ç´¢å¼•
6. âœ… æ•°æ®è¿ç§»ï¼ˆå¦‚æœæœ‰æ—§æ•°æ®ï¼‰

**éªŒè¯æ ‡å‡†**:
- æ‰€æœ‰è¡¨åˆ›å»ºæˆåŠŸ
- ç´¢å¼•åˆ›å»ºæˆåŠŸ
- æ•°æ®è¿ç§»å®Œæˆ
- æ— æ•°æ®ä¸¢å¤±

---

#### é˜¶æ®µäºŒï¼šAPI æ¥å£å¼€å‘ï¼ˆ2å¤©ï¼‰

**ä»»åŠ¡æ¸…å•**:
1. âœ… å®ç° `/api/device/config` æ¥å£
2. âœ… å®ç° `/api/third-party/callback/{type}` æ¥å£
3. âœ… å®ç° `/api/third-party/fallback/message` æ¥å£
4. âœ… å®ç° `/api/robots/[robotId]/config` æ¥å£
5. âœ… å®ç° `/api/robots/[robotId]/config-status` æ¥å£
6. âœ… å®ç° `/api/worktool/message-log` æ¥å£

**éªŒè¯æ ‡å‡†**:
- æ‰€æœ‰æ¥å£å¼€å‘å®Œæˆ
- æ¥å£æµ‹è¯•é€šè¿‡
- é”™è¯¯å¤„ç†å®Œå–„
- æ–‡æ¡£ç¼–å†™å®Œæˆ

---

#### é˜¶æ®µä¸‰ï¼šWebSocket åè®®æ‰©å±•ï¼ˆ1å¤©ï¼‰

**ä»»åŠ¡æ¸…å•**:
1. âœ… æ‰©å±• WebSocket æ¶ˆæ¯ç±»å‹
2. âœ… å®ç°é…ç½®æ¨é€é€»è¾‘
3. âœ… å®ç°é…ç½®ç¡®è®¤/æ‹’ç»å¤„ç†
4. âœ… å®ç°æ¶ˆæ¯å›è°ƒæ¨é€
5. âœ… å®ç°æ¶ˆæ¯æ—¥å¿—ä¸ŠæŠ¥å¤„ç†
6. âœ… æµ‹è¯• WebSocket é€šä¿¡

**éªŒè¯æ ‡å‡†**:
- æ‰€æœ‰æ¶ˆæ¯ç±»å‹å®ç°å®Œæˆ
- æ¶ˆæ¯å¤„ç†æ­£ç¡®
- å¼‚å¸¸å¤„ç†å®Œå–„
- é€šä¿¡ç¨³å®š

---

#### é˜¶æ®µå››ï¼šç³»ç»Ÿé›†æˆæµ‹è¯•ï¼ˆ2å¤©ï¼‰

**ä»»åŠ¡æ¸…å•**:
1. âœ… é…ç½®åŒæ­¥æµç¨‹æµ‹è¯•
2. âœ… æ¶ˆæ¯å‘é€æµç¨‹æµ‹è¯•
3. âœ… å›é€€æœºåˆ¶æµ‹è¯•
4. âœ… å¼‚å¸¸æƒ…å†µæµ‹è¯•
5. âœ… æ€§èƒ½æµ‹è¯•
6. âœ… å‹åŠ›æµ‹è¯•

**éªŒè¯æ ‡å‡†**:
- æ‰€æœ‰æµç¨‹æµ‹è¯•é€šè¿‡
- å¼‚å¸¸æƒ…å†µå¤„ç†æ­£ç¡®
- æ€§èƒ½æ»¡è¶³è¦æ±‚
- å‹åŠ›æµ‹è¯•é€šè¿‡

---

#### é˜¶æ®µäº”ï¼šæ–‡æ¡£ç¼–å†™ï¼ˆ1å¤©ï¼‰

**ä»»åŠ¡æ¸…å•**:
1. âœ… æ›´æ–° API æ–‡æ¡£
2. âœ… æ›´æ–° WebSocket åè®®æ–‡æ¡£
3. âœ… ç¼–å†™æ•°æ®åº“è®¾è®¡æ–‡æ¡£
4. âœ… ç¼–å†™éƒ¨ç½²æŒ‡å—
5. âœ… ç¼–å†™æ•…éšœæ’æŸ¥æŒ‡å—

**éªŒè¯æ ‡å‡†**:
- æ–‡æ¡£å®Œæ•´
- æ–‡æ¡£å‡†ç¡®
- æ–‡æ¡£æ˜“æ‡‚

---

#### é˜¶æ®µå…­ï¼šéƒ¨ç½²ä¸Šçº¿ï¼ˆ1å¤©ï¼‰

**ä»»åŠ¡æ¸…å•**:
1. âœ… å¤‡ä»½æ•°æ®åº“
2. âœ… æ‰§è¡Œæ•°æ®åº“è¿ç§»
3. âœ… éƒ¨ç½²æ–°ç‰ˆæœ¬
4. âœ… éªŒè¯éƒ¨ç½²ç»“æœ
5. âœ… ç›‘æ§è¿è¡ŒçŠ¶æ€

**éªŒè¯æ ‡å‡†**:
- æ•°æ®åº“è¿ç§»æˆåŠŸ
- éƒ¨ç½²æˆåŠŸ
- åŠŸèƒ½æ­£å¸¸
- æ— å¼‚å¸¸æŠ¥é”™

---

### 7.2 é£é™©è¯„ä¼°

| é£é™©é¡¹ | é£é™©ç­‰çº§ | å½±å“ | åº”å¯¹æªæ–½ |
|--------|---------|------|---------|
| æ•°æ®åº“è¿ç§»å¤±è´¥ | ğŸŸ¡ ä¸­ | æ— æ³•åˆ›å»ºæ–°è¡¨ | 1. æå‰æµ‹è¯•è¿ç§»è„šæœ¬<br>2. å‡†å¤‡å›æ»šæ–¹æ¡ˆ<br>3. å¤‡ä»½æ•°æ®åº“ |
| é…ç½®åŒæ­¥å¤±è´¥ | ğŸŸ¡ ä¸­ | é…ç½®æ— æ³•æ¨é€ | 1. å®ç°é‡è¯•æœºåˆ¶<br>2. æä¾›æ‰‹åŠ¨æŸ¥è¯¢æ¥å£<br>3. è®°å½•è¯¦ç»†æ—¥å¿— |
| ç¬¬ä¸‰æ–¹APIä¸å¯ç”¨ | ğŸŸ¢ ä½ | æ¶ˆæ¯å‘é€å¤±è´¥ | 1. å®ç°å›é€€æœºåˆ¶<br>2. è‡ªåŠ¨åˆ‡æ¢åˆ°ä¸»æœåŠ¡å™¨<br>3. è®°å½•å¤±è´¥æ—¥å¿— |
| WebSocket è¿æ¥ä¸ç¨³å®š | ğŸŸ¢ ä½ | æ¶ˆæ¯æ¨é€å»¶è¿Ÿ | 1. å®ç°é‡è¿æœºåˆ¶<br>2. å¢åŠ å¿ƒè·³æ£€æµ‹<br>3. ä¼˜åŒ–ç½‘ç»œé…ç½® |
| æ€§èƒ½é—®é¢˜ | ğŸŸ¢ ä½ | å“åº”å˜æ…¢ | 1. æ·»åŠ ç¼“å­˜<br>2. ä¼˜åŒ–æŸ¥è¯¢<br>3. å¢åŠ ç›‘æ§ |

---

### 7.3 å›é€€æ–¹æ¡ˆ

#### 7.3.1 æ•°æ®åº“å›é€€

```sql
-- åˆ é™¤æ–°å¢çš„è¡¨
DROP TABLE IF EXISTS message_fail_logs CASCADE;
DROP TABLE IF EXISTS config_sync_logs CASCADE;
DROP TABLE IF EXISTS sessions CASCADE;
DROP TABLE IF EXISTS device_activations CASCADE;
```

#### 7.3.2 ä»£ç å›é€€

```bash
# å›é€€åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
git revert <commit-hash>

# æˆ–è€…åˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªåˆ†æ”¯
git checkout <previous-branch>
```

#### 7.3.3 é…ç½®å›é€€

```bash
# æ¢å¤ç¯å¢ƒå˜é‡
cp .env.backup .env

# é‡å¯æœåŠ¡
pnpm dev
```

---

## å…«ã€å…³é”®è¡”æ¥ç‚¹

### 8.1 æ•°æ®åº“è¡”æ¥

#### 8.1.1 robots è¡¨ä¸ device_activations è¡¨çš„å…³ç³»

```
robots è¡¨ï¼š
- robot_id (æœºå™¨äººID)
- third_party_callback_url (ç¬¬ä¸‰æ–¹å›è°ƒåœ°å€)
- third_party_result_callback_url (ç¬¬ä¸‰æ–¹ç»“æœå›è°ƒåœ°å€)
- third_party_secret_key (ç¬¬ä¸‰æ–¹å¯†é’¥)

device_activations è¡¨ï¼š
- robot_id (æœºå™¨äººIDï¼Œå¤–é”®)
- config_version (é…ç½®ç‰ˆæœ¬å·)
- config_synced_at (é…ç½®åŒæ­¥æ—¶é—´)
- config_synced (é…ç½®æ˜¯å¦å·²åŒæ­¥)
- config_error (é…ç½®é”™è¯¯ä¿¡æ¯)
```

**è¡”æ¥é€»è¾‘**:
1. æœºå™¨äººé…ç½®ä¿®æ”¹æ—¶ï¼Œæ›´æ–° `robots` è¡¨
2. é€šè¿‡ WebSocket æ¨é€é…ç½®åˆ° APP
3. APP ç¡®è®¤åï¼Œæ›´æ–° `device_activations` è¡¨çš„åŒæ­¥çŠ¶æ€

---

#### 8.1.2 messages è¡¨ä¸ sessions è¡¨çš„å…³ç³»

```
sessions è¡¨ï¼š
- session_id (ä¼šè¯ID)
- robot_id (æœºå™¨äººID)
- user_id (ç”¨æˆ·ID)
- status (çŠ¶æ€)

messages è¡¨ï¼š
- conversation_id (ä¼šè¯IDï¼Œå¤–é”®)
- robot_id (æœºå™¨äººID)
- member_id (æˆå‘˜ID)
- message_type (æ¶ˆæ¯ç±»å‹)
- direction (æ–¹å‘)
- content (å†…å®¹)
```

**è¡”æ¥é€»è¾‘**:
1. æ”¶åˆ°æ¶ˆæ¯æ—¶ï¼ŒæŸ¥æ‰¾æˆ–åˆ›å»ºä¼šè¯
2. å°†æ¶ˆæ¯ä¿å­˜åˆ° `messages` è¡¨ï¼Œå…³è” `conversation_id`
3. æ›´æ–° `sessions` è¡¨çš„æœ€åæ¶ˆæ¯æ—¶é—´

---

### 8.2 API æ¥å£è¡”æ¥

#### 8.2.1 æ¿€æ´»æ¥å£ä¸é…ç½®æ¨é€

```
/api/robot-ids/activate (POST)
    â†“
1. éªŒè¯æ¿€æ´»ç 
2. åˆ›å»º/æ›´æ–° device_activations è®°å½•
3. æŸ¥è¯¢æœºå™¨äººé…ç½®
4. é€šè¿‡ WebSocket æ¨é€é…ç½®
5. è¿”å› Token
```

**è¡”æ¥ç‚¹**: æ¿€æ´»æˆåŠŸåç«‹å³æ¨é€é…ç½®

---

#### 8.2.2 é…ç½®æ¥å£ä¸ WebSocket æ¨é€

```
/api/robots/[robotId]/config (PUT)
    â†“
1. æ›´æ–° robots è¡¨é…ç½®
2. æ£€æŸ¥æœºå™¨äººæ˜¯å¦åœ¨çº¿
3. é€šè¿‡ WebSocket æ¨é€é…ç½®
4. æ›´æ–° config_sync_logs è¡¨
```

**è¡”æ¥ç‚¹**: é…ç½®ä¿®æ”¹æ—¶ç«‹å³æ¨é€

---

#### 8.2.3 ç¬¬ä¸‰æ–¹å›è°ƒä¸ WebSocket æ¨é€

```
/api/third-party/callback/result (POST)
    â†“
1. éªŒè¯ Token
2. æå–æ¶ˆæ¯å†…å®¹
3. é€šè¿‡ WebSocket æ¨é€ç»™ APP
4. æ›´æ–° messages è¡¨
```

**è¡”æ¥ç‚¹**: æ”¶åˆ°ç¬¬ä¸‰æ–¹å›å¤åç«‹å³æ¨é€

---

### 8.3 WebSocket æ¶ˆæ¯è¡”æ¥

#### 8.3.1 é…ç½®æ¨é€ä¸é…ç½®ç¡®è®¤

```
æœåŠ¡å™¨ â†’ APP: config_push
    â†“
APP æ”¶åˆ°é…ç½®
    â†“
APP ä¿å­˜åˆ°æœ¬åœ°
    â†“
APP â†’ æœåŠ¡å™¨: config_ack
    â†“
æœåŠ¡å™¨æ›´æ–° device_activations.config_synced = true
```

**è¡”æ¥ç‚¹**: APP ç¡®è®¤åæ›´æ–°åŒæ­¥çŠ¶æ€

---

#### 8.3.2 æ¶ˆæ¯å‘é€ä¸å›é€€

```
APP â†’ ç¬¬ä¸‰æ–¹å¹³å°: å‘é€æ¶ˆæ¯
    â†“
ç¬¬ä¸‰æ–¹å¹³å°è¿”å›é”™è¯¯
    â†“
APP æ£€æµ‹åˆ°å¤±è´¥
    â†“
APP â†’ æœåŠ¡å™¨: /api/third-party/fallback/message
    â†“
æœåŠ¡å™¨å¤„ç†æ¶ˆæ¯
    â†“
æœåŠ¡å™¨ â†’ APP: command_push
```

**è¡”æ¥ç‚¹**: å‘é€å¤±è´¥åè‡ªåŠ¨å›é€€

---

## ä¹ã€æ€»ç»“

### 9.1 ç³»ç»Ÿç°çŠ¶

âœ… **ä¼˜ç‚¹**:
1. æ¶æ„æ¸…æ™°ï¼Œå‰åç«¯åˆ†ç¦»
2. WebSocket å®æ—¶é€šä¿¡å·²å®ç°
3. æ•°æ®åº“è®¾è®¡å®Œå–„
4. API æ¥å£é½å…¨
5. è®¤è¯æˆæƒæœºåˆ¶å¥å…¨

âš ï¸ **ä¸è¶³**:
1. ç¬¬ä¸‰æ–¹é›†æˆä¸å¤Ÿçµæ´»
2. é…ç½®åŒæ­¥æœºåˆ¶ç¼ºå¤±
3. å›é€€æœºåˆ¶æœªå®ç°
4. æ—¥å¿—è®°å½•ä¸å¤Ÿå®Œæ•´

### 9.2 æ–°æ–¹æ¡ˆä¼˜åŠ¿

âœ… **æ¶æ„ä¼˜åŠ¿**:
1. APP ç›´æ¥å‘é€æ¶ˆæ¯ï¼Œå‡å°‘æœåŠ¡å™¨å‹åŠ›
2. æ™ºèƒ½å›é€€æœºåˆ¶ï¼Œæé«˜å¯é æ€§
3. é…ç½®åŒæ­¥ç¡®è®¤ï¼Œç¡®ä¿ä¸€è‡´æ€§
4. å®Œæ•´çš„æ—¥å¿—è®°å½•ï¼Œä¾¿äºè°ƒè¯•

âœ… **åŠŸèƒ½ä¼˜åŠ¿**:
1. åŒé‡é…ç½®åŒæ­¥ï¼ˆWebSocket + ä¸»åŠ¨æŸ¥è¯¢ï¼‰
2. åŠ¨æ€å›è°ƒåœ°å€ç”Ÿæˆ
3. æ¶ˆæ¯å‘é€å¤±è´¥é‡è¯•
4. é…ç½®ç‰ˆæœ¬ç®¡ç†

âœ… **å…¼å®¹æ€§ä¼˜åŠ¿**:
1. å‘åå…¼å®¹ç°æœ‰åè®®
2. ä¸å½±å“ç°æœ‰åŠŸèƒ½
3. æ•°æ®è¿ç§»é£é™©ä½
4. å›é€€æ–¹æ¡ˆå®Œå–„

### 9.3 å®æ–½å»ºè®®

**ä¼˜å…ˆçº§æ’åº**:
1. ğŸ”´ **é«˜ä¼˜å…ˆçº§**ï¼šæ•°æ®åº“å‡†å¤‡ã€æ ¸å¿ƒAPIæ¥å£ã€WebSocketåè®®æ‰©å±•
2. ğŸŸ¡ **ä¸­ä¼˜å…ˆçº§**ï¼šé…ç½®ç®¡ç†æ¥å£ã€æ—¥å¿—æ¥å£
3. ğŸŸ¢ **ä½ä¼˜å…ˆçº§**ï¼šç›‘æ§æ¥å£ã€ç»Ÿè®¡æ¥å£

**æµ‹è¯•é‡ç‚¹**:
1. é…ç½®åŒæ­¥æµç¨‹
2. æ¶ˆæ¯å‘é€æµç¨‹
3. å›é€€æœºåˆ¶
4. å¼‚å¸¸å¤„ç†

**æ–‡æ¡£é‡ç‚¹**:
1. API æ¥å£æ–‡æ¡£
2. WebSocket åè®®æ–‡æ¡£
3. éƒ¨ç½²æŒ‡å—
4. æ•…éšœæ’æŸ¥æŒ‡å—

---

## é™„å½•

### A. å…³é”®ä»£ç ç‰‡æ®µ

#### A.1 è®¾å¤‡æ¿€æ´»æ¥å£ï¼ˆä¿®æ”¹åï¼‰

```typescript
// src/app/api/robot-ids/activate/route.ts

export async function POST(request: NextRequest) {
  // 1. éªŒè¯æ¿€æ´»ç 
  // 2. æ£€æŸ¥è®¾å¤‡ç»‘å®š
  // 3. åˆ›å»º/æ›´æ–° device_activations è®°å½• â­
  await db.execute(sql`
    INSERT INTO device_activations (
      robot_id, robot_uuid, device_id, user_id,
      activation_code, status, activated_at,
      device_info
    )
    VALUES (
      ${robotId}, ${robotUuid}, ${deviceId}, ${userId},
      ${code}, 'active', NOW(),
      ${JSON.stringify(deviceInfo)}
    )
    ON CONFLICT (robot_id) DO UPDATE SET
      last_seen_at = NOW(),
      updated_at = NOW()
  `);

  // 4. æŸ¥è¯¢æœºå™¨äººé…ç½® â­
  const robot = await db.execute(sql`
    SELECT
      third_party_callback_url,
      third_party_result_callback_url,
      third_party_secret_key,
      EXTRACT(EPOCH FROM updated_at) * 1000 as updated_at_timestamp
    FROM robots
    WHERE robot_id = ${robotId}
    LIMIT 1
  `);

  // 5. é€šè¿‡ WebSocket æ¨é€é…ç½® â­
  if (robot.rows.length > 0) {
    const robotData = robot.rows[0];
    pushConfigToRobot(robotId, {
      worktoolApiUrl: robotData.third_party_callback_url,
      resultCallbackUrl: robotData.third_party_result_callback_url,
      secretKey: robotData.third_party_secret_key,
      updatedAt: robotData.updated_at_timestamp,
      version: '1.0'
    });
  }

  // 6. è¿”å› Token
  return NextResponse.json({
    code: 201,
    data: {
      robotId,
      token,
      expiresIn: 86400
    }
  });
}
```

#### A.2 é…ç½®æ¨é€å‡½æ•°

```typescript
// src/server/websocket/message-handler.ts

async function pushConfigToRobot(robotId: string, config: ConfigPushData) {
  const connection = connectionManager.getConnection(robotId);
  if (!connection) {
    console.log(`[WebSocket] æœºå™¨äººç¦»çº¿ï¼Œæ— æ³•æ¨é€é…ç½®: ${robotId}`);
    return;
  }

  // å‘é€é…ç½®æ¨é€æ¶ˆæ¯
  sendMessage(connection, {
    type: WSMessageType.CONFIG_PUSH,
    data: config,
    timestamp: Date.now()
  });

  // è®°å½•æ¨é€æ—¥å¿—
  await db.execute(sql`
    INSERT INTO config_sync_logs (
      robot_id, config_version, config_data,
      sync_status, created_at
    )
    VALUES (
      ${robotId}, ${config.version}, ${JSON.stringify(config)},
      'pending', NOW()
    )
  `);

  console.log(`[WebSocket] é…ç½®å·²æ¨é€: ${robotId}`);
}
```

#### A.3 é…ç½®ç¡®è®¤å¤„ç†

```typescript
// src/server/websocket/message-handler.ts

async function handleConfigAck(connection: WebSocketConnection, message: WSMessage) {
  const { robotId, configVersion, ackTime } = message.data;

  // æ›´æ–°é…ç½®åŒæ­¥çŠ¶æ€
  await db.execute(sql`
    UPDATE device_activations
    SET config_synced = true,
        config_synced_at = ${ackTime}
    WHERE robot_id = ${robotId}
  `);

  // æ›´æ–°åŒæ­¥æ—¥å¿—
  await db.execute(sql`
    UPDATE config_sync_logs
    SET sync_status = 'synced',
        synced_at = ${ackTime}
    WHERE robot_id = ${robotId}
      AND config_version = ${configVersion}
      AND sync_status = 'pending'
    ORDER BY created_at DESC
    LIMIT 1
  `);

  console.log(`[WebSocket] é…ç½®ç¡®è®¤: ${robotId}, ç‰ˆæœ¬: ${configVersion}`);
}
```

### B. æ•°æ®åº“è¿ç§»è„šæœ¬

```sql
-- åˆ›å»ºè®¾å¤‡æ¿€æ´»è¡¨
CREATE TABLE IF NOT EXISTS device_activations (
  id SERIAL PRIMARY KEY,
  robot_id VARCHAR(255) NOT NULL UNIQUE,
  robot_uuid VARCHAR(255) NOT NULL UNIQUE,
  device_id VARCHAR(255),
  user_id INTEGER,
  activation_code VARCHAR(8),
  status VARCHAR(20) NOT NULL DEFAULT 'active',
  activated_at TIMESTAMP DEFAULT NOW(),
  expires_at TIMESTAMP,
  last_seen_at TIMESTAMP,
  device_info TEXT,

  config_version INTEGER DEFAULT 0,
  config_synced_at TIMESTAMP,
  config_synced BOOLEAN DEFAULT true,
  config_error TEXT,

  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX device_activations_robot_id_idx ON device_activations(robot_id);
CREATE INDEX device_activations_device_id_idx ON device_activations(device_id);
CREATE INDEX device_activations_user_id_idx ON device_activations(user_id);

-- åˆ›å»ºé…ç½®åŒæ­¥æ—¥å¿—è¡¨
CREATE TABLE IF NOT EXISTS config_sync_logs (
  id SERIAL PRIMARY KEY,
  robot_id VARCHAR(255) NOT NULL,
  config_version VARCHAR(50) NOT NULL,
  config_data JSONB NOT NULL,
  sync_status VARCHAR(20) NOT NULL DEFAULT 'pending',
  synced_at TIMESTAMP,
  error_message TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX config_sync_logs_robot_id_idx ON config_sync_logs(robot_id);
CREATE INDEX config_sync_logs_status_idx ON config_sync_logs(sync_status);
CREATE INDEX config_sync_logs_version_idx ON config_sync_logs(config_version);

-- åˆ›å»ºæ¶ˆæ¯å‘é€å¤±è´¥æ—¥å¿—è¡¨
CREATE TABLE IF NOT EXISTS message_fail_logs (
  id SERIAL PRIMARY KEY,
  robot_id VARCHAR(255) NOT NULL,
  message_id VARCHAR(255) NOT NULL,
  third_party_url TEXT NOT NULL,
  error_message TEXT NOT NULL,
  error_type VARCHAR(50),
  retry_count INTEGER DEFAULT 0,
  failed_at TIMESTAMP DEFAULT NOW(),
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX message_fail_logs_robot_id_idx ON message_fail_logs(robot_id);
CREATE INDEX message_fail_logs_message_id_idx ON message_fail_logs(message_id);
CREATE INDEX message_fail_logs_error_type_idx ON message_fail_logs(error_type);
CREATE INDEX message_fail_logs_created_at_idx ON message_fail_logs(created_at);

-- åˆ›å»ºä¼šè¯è¡¨
CREATE TABLE IF NOT EXISTS sessions (
  id SERIAL PRIMARY KEY,
  session_id VARCHAR(255) NOT NULL UNIQUE,
  robot_id VARCHAR(255) NOT NULL,
  user_id VARCHAR(255),
  status VARCHAR(20) NOT NULL DEFAULT 'active',
  message_count INTEGER DEFAULT 0,
  last_message_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX sessions_session_id_idx ON sessions(session_id);
CREATE INDEX sessions_robot_id_idx ON sessions(robot_id);
CREATE INDEX sessions_user_id_idx ON sessions(user_id);
```

### C. æµ‹è¯•ç”¨ä¾‹

#### C.1 é…ç½®åŒæ­¥æµç¨‹æµ‹è¯•

```typescript
// æµ‹è¯•åœºæ™¯ï¼šç®¡ç†å‘˜ä¿®æ”¹é…ç½®

describe('é…ç½®åŒæ­¥æµç¨‹', () => {
  it('åº”è¯¥æˆåŠŸæ¨é€é…ç½®åˆ°åœ¨çº¿çš„APP', async () => {
    // 1. ä¿®æ”¹é…ç½®
    await request(app)
      .put(`/api/robots/${robotId}/config`)
      .send({
        thirdPartyCallbackUrl: 'https://api.dify.ai/callback',
        thirdPartyResultCallbackUrl: 'https://api.dify.ai/result',
        thirdPartySecretKey: 'secret_xxx'
      })
      .expect(200);

    // 2. éªŒè¯é…ç½®å·²ä¿å­˜
    const robot = await db.query.robots.findFirst({
      where: eq(robots.robotId, robotId)
    });
    expect(robot?.thirdPartyCallbackUrl).toBe('https://api.dify.ai/callback');

    // 3. éªŒè¯é…ç½®å·²æ¨é€
    const syncLog = await db.query.configSyncLogs.findFirst({
      where: eq(configSyncLogs.robotId, robotId)
    });
    expect(syncLog?.syncStatus).toBe('pending');

    // 4. æ¨¡æ‹ŸAPPç¡®è®¤
    ws.send(JSON.stringify({
      type: 'config_ack',
      data: {
        robotId,
        configVersion: '1.0',
        ackTime: new Date().toISOString()
      }
    }));

    // 5. éªŒè¯é…ç½®å·²ç¡®è®¤
    await sleep(1000);
    const updatedLog = await db.query.configSyncLogs.findFirst({
      where: eq(configSyncLogs.robotId, robotId)
    });
    expect(updatedLog?.syncStatus).toBe('synced');
  });
});
```

#### C.2 æ¶ˆæ¯å›é€€æµç¨‹æµ‹è¯•

```typescript
describe('æ¶ˆæ¯å›é€€æµç¨‹', () => {
  it('åº”è¯¥æˆåŠŸå›é€€åˆ°ä¸»æœåŠ¡å™¨', async () => {
    // 1. æ¨¡æ‹ŸAPPå‘é€æ¶ˆæ¯åˆ°ç¬¬ä¸‰æ–¹å¹³å°å¤±è´¥
    await request(app)
      .post('/api/third-party/fallback/message')
      .set('Authorization', `Bearer ${token}`)
      .send({
        robotId,
        content: 'ä½ å¥½',
        messageType: 'text',
        senderId: 'wxid_xxx',
        senderName: 'å¼ ä¸‰'
      })
      .expect(200);

    // 2. éªŒè¯æ¶ˆæ¯å·²ä¿å­˜
    const message = await db.query.messages.findFirst({
      where: eq(messages.robotId, robotId)
    });
    expect(message?.content).toBe('ä½ å¥½');

    // 3. éªŒè¯å·²ç”Ÿæˆå›å¤
    const reply = await db.query.messages.findFirst({
      where: and(
        eq(messages.robotId, robotId),
        eq(messages.direction, 'outgoing')
      )
    });
    expect(reply).toBeDefined();
  });
});
```

---

**æ–‡æ¡£ç»“æŸ**
